<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Mobile-friendly viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Darts Golf Scorer</title>
    <style>
        :root {
            --bg-color: #1a1a1a; /* Dartboard Black */
            --text-color: #f0f0f0;
            --border-color: #444;
            --primary-color: #d92727; /* Dartboard Red */
            --secondary-color: #008746; /* Dartboard Green */
            --accent-color: #e5d8b1; /* Sisal Beige */
            --accent-text-color: #000;
        }
        html, body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            height: 100svh; display: flex; flex-direction: column;
        }
        body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }

        .container {
            flex: 1; overflow-y: auto; 
            /* 2px edges as requested */
            padding: 15px 2px;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .container::-webkit-scrollbar { display: none; }
        
        .controls { flex-shrink: 0; padding: 10px; background-color: #000; border-top: 2px solid var(--border-color); }
        .setup-screen { text-align: center; padding-top: 18vh; max-width: 900px; margin: 0 auto; }
        .setup-screen h1 { color: var(--text-color); margin-bottom: 10px; }
        .flash { margin: 0 auto 16px; padding: 12px 16px; border-radius: 8px; border: 1px solid #ff4d4d; background: #2a0000; color: #ffcccc; font-weight: 600; }
        .setup-screen input { width: 100%; max-width: 720px; padding: 15px; font-size: 1.2em; margin: 10px auto 20px; display: block; }
        .setup-screen small { display: block; color: #bbb; margin-top: -8px; margin-bottom: 16px; }
        .setup-screen button { padding: 15px 30px; font-size: 1.2em; background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; cursor: pointer;}
        
        .scoreboard { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 20px; }
        .scoreboard th, .scoreboard td { border: 1px solid var(--border-color); text-align: center; word-wrap: break-word; }
        .scoreboard thead th { font-size: 1.2em; padding: 8px 5px; line-height: 1.4; vertical-align: middle; background-color: #333;}
        .scoreboard tbody th, .scoreboard tbody td { font-size: 1.5em; padding: 12px 5px; vertical-align: middle; }
        .scoreboard tbody th { background-color: #2b2b2b; font-size: 1.1em; }
        .scoreboard tbody td { background-color: var(--accent-color); color: var(--accent-text-color); font-weight: bold;}
        .scoreboard .total-row td { background-color: #333; color: var(--text-color); }
        
        .current-player-header { color: var(--primary-color); font-weight: bold; }
        .info-bar { text-align: center; margin-bottom: 15px; font-size: 1.3em; font-weight: bold;}
        .info-bar .turn-info { color: var(--primary-color); }
        .button-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 10px; }
        .utility-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .button-grid button, .utility-grid button { width: 100%; padding: 20px 0; font-size: 1.8em; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; touch-action: manipulation; }
        .score-btn.plus { background-color: var(--secondary-color); color: white; }
        .score-btn.minus { background-color: var(--primary-color); color: white; }
        .score-btn.zero { background-color: #616161; color: white; }
        .undo-btn { background-color: #ff9800; color: black; }
        .restart-btn { background-color: #f44336; color: white; }
        .status-box { text-align: center; padding: 20px 15px; margin: 20px auto; border: 2px solid var(--primary-color); border-radius: 10px; background: #222; }
        .status-box h1 { font-size: 2em; margin-top: 0; color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="container">
        {% if game.phase == 'setup' %}
        <div class="setup-screen">
            <h1>Darts Golf Scorer</h1>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, msg in messages %}
                        <div class="flash">{{ msg }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form action="{{ url_for('start_game') }}" method="post">
                <input type="text" name="players" placeholder="Enter player names, separated by commas" required>
                <small>Example: Alice, Bob, Charlie â€” names must be unique (case-insensitive).</small>
                <button type="submit">Start Game</button>
            </form>
        </div>

        {% elif game.phase == 'playing' %}
        <div class="info-bar" id="info-bar">
            <span>Round: {{ "%02d"|format(game.current_round) }} / 20</span> - 
            <span class="turn-info">{{ game.players[game.current_player_index] }}'s Turn</span>
        </div>
        <table class="scoreboard" id="scoreboard">
            <thead>
                <tr>
                    <th>&nbsp;</th>
                    {% for player in game.players %}
                        <th class="{{ 'current-player-header' if player == game.players[game.current_player_index] else '' }}">{{ player }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <tr class="total-row">
                    <th>Total</th>
                    {% for player in game.players %}
                        <td>
                            {% set total_score = game.scores.get(player, 0) %}
                            {% if total_score > 0 %}+{% endif %}{{ total_score }}
                        </td>
                    {% endfor %}
                </tr>
                {% for i in range(game.current_round - 1) | reverse %}
                <tr>
                    <th>{{ "%02d"|format(i + 1) }}</th>
                    {% for player in game.players %}
                        <td>
                            {% set score = game.round_history[i].get(player) %}
                            {% if score is not none %}{% if score > 0 %}+{% endif %}{{ score }}{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% elif game.phase == 'playoff' %}
        <div class="info-bar" id="info-bar">
            <span>Playoff for {{ game.playoff_base_score }} points</span> - 
            <span class="turn-info">{{ game.playoff_group[game.current_player_index] }}'s Turn</span>
        </div>
        <table class="scoreboard" id="scoreboard">
             <thead>
                <tr>
                    <th>&nbsp;</th>
                    {% for player in game.playoff_group %}
                        <th class="{{ 'current-player-header' if player == game.playoff_group[game.current_player_index] else '' }}">{{ player }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <tr class="total-row">
                    <th>Total</th>
                    {% for player in game.playoff_group %}
                        <td>
                            {% set total_score = game.playoff_base_score %}
                            {% if total_score > 0 %}+{% endif %}{{ total_score }}
                        </td>
                    {% endfor %}
                </tr>
                {% for round_scores in game.playoff_history %}
                <tr>
                    <th>TB {{ "%02d"|format(loop.index) }}</th>
                    {% for player in game.playoff_group %}
                        <td>
                            {% set score = round_scores.get(player) %}
                            {% if score is not none %}{% if score > 0 %}+{% endif %}{{ score }}{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% elif game.phase == 'final_ranking' %}
        <div class="status-box"><h1>Final Standings</h1></div>
        <table class="scoreboard" id="scoreboard">
            <thead>
                <tr>
                    <th>&nbsp;</th>
                    {% for standing in game.final_standings %}
                        <th>
                            {% set rank = standing.rank %}
                            {% set suffix = 'th' %}
                            {% if rank % 10 == 1 and rank % 100 != 11 %}{% set suffix = 'st' %}{% endif %}
                            {% if rank % 10 == 2 and rank % 100 != 12 %}{% set suffix = 'nd' %}{% endif %}
                            {% if rank % 10 == 3 and rank % 100 != 13 %}{% set suffix = 'rd' %}{% endif %}
                            {{ rank }}{{ suffix }}
                        </th>
                    {% endfor %}
                </tr>
                <tr>
                    <th>Player</th>
                    {% for standing in game.final_standings %}
                        <th>{{ standing.name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <tr class="total-row">
                    <th>Final</th>
                    {% for standing in game.final_standings %}
                        <td>
                            {% set total_score = standing.score %}
                            {% if total_score > 0 %}+{% endif %}{{ total_score }}
                        </td>
                    {% endfor %}
                </tr>
                {% for i in range(game.max_playoff_rounds, 0, -1) %}
                <tr>
                    <th>TB {{ "%02d"|format(i) }}</th>
                    {% for standing in game.final_standings %}
                        <td>
                            {% set player_history = game.all_playoff_history.get(standing.name, []) %}
                            {% if i <= player_history|length %}
                                {% set score = player_history[i-1] %}
                                {% if score > 0 %}+{% endif %}{{ score }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
                
                {% for i in range(19, -1, -1) %}
                <tr>
                    <th>{{ "%02d"|format(i + 1) }}</th>
                    {% for standing in game.final_standings %}
                        <td>
                            {% set score = game.round_history[i].get(standing.name) %}
                            {% if score is not none %}{% if score > 0 %}+{% endif %}{{ score }}{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    <div class="controls">
        {% if game.phase == 'playing' or game.phase == 'playoff' %}
        <div class="button-grid">
            <!-- Added -3 button; all buttons call JS (no page reload) -->
            <button type="button" class="score-btn minus" onclick="sendScore(-3)">-3</button>
            <button type="button" class="score-btn minus" onclick="sendScore(-2)">-2</button>
            <button type="button" class="score-btn minus" onclick="sendScore(-1)">-1</button>
            <button type="button" class="score-btn zero"  onclick="sendScore(0)">0</button>
            <button type="button" class="score-btn plus"  onclick="sendScore(1)">+1</button>
            <button type="button" class="score-btn plus"  onclick="sendScore(2)">+2</button>
        </div>
        <div class="utility-grid">
            <button type="button" id="undoBtn" class="undo-btn" onclick="undo()" {{ 'disabled' if game.phase == 'playoff' else '' }}>Undo</button>
            <!-- Keep restart as full reload (server resets cleanly) -->
            <form action="{{ url_for('restart') }}" method="post" onsubmit="return confirm('Are you sure you want to restart the game?');">
                <button type="submit" class="restart-btn">Restart Game</button>
            </form>
        </div>
        {% elif game.phase == 'final_ranking' %}
        <div class="utility-grid">
            <form style="grid-column: 1 / -1;" action="{{ url_for('restart') }}" method="post" onsubmit="return confirm('Are you sure you want to start a new game?');">
                <button type="submit" class="restart-btn">Start New Game</button>
            </form>
        </div>
        {% endif %}
    </div>

    <script>
    // ---- Small helpers ----
    function fmtSigned(n) { return (n > 0 ? '+' : '') + n; }
    function qs(sel) { return document.querySelector(sel); }

    async function sendScore(val) {
        const res = await fetch('{{ url_for("api_score") }}', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({score: val})
        });
        const data = await res.json();
        if (!data.ok) return;
        const g = data.game;

        // If we hit final_ranking, just reload once to render the complex table server-side.
        if (g.phase === 'final_ranking') {
            location.reload();
            return;
        }
        renderGame(g);
    }

    async function undo() {
        const res = await fetch('{{ url_for("api_undo") }}', { method: 'POST' });
        const data = await res.json();
        if (!data.ok) return;
        renderGame(data.game);
    }

    function renderGame(g) {
        if (g.phase === 'playing') {
            renderPlaying(g);
            qs('#undoBtn')?.removeAttribute('disabled');
        } else if (g.phase === 'playoff') {
            renderPlayoff(g);
            qs('#undoBtn')?.setAttribute('disabled','disabled');
        }
    }

    function renderPlaying(g) {
        // Info bar
        const info = `<span>Round: ${String(g.current_round).padStart(2,'0')} / 20</span> - 
                      <span class="turn-info">${g.players[g.current_player_index]}'s Turn</span>`;
        qs('#info-bar').innerHTML = info;

        // Header row
        const headers = g.players.map((p, i) => {
            const cls = (i === g.current_player_index) ? 'current-player-header' : '';
            return `<th class="${cls}">${p}</th>`;
        }).join('');
        const thead = `<thead><tr><th>&nbsp;</th>${headers}</tr></thead>`;

        // Totals row
        const totals = g.players.map(p => {
            const s = g.scores[p] || 0;
            return `<td>${s > 0 ? '+' : ''}${s}</td>`;
        }).join('');
        let tbody = `<tbody><tr class="total-row"><th>Total</th>${totals}</tr>`;

        // Past rounds (reverse order like template)
        for (let i = g.current_round - 2; i >= 0; i--) {
            const cells = g.players.map(p => {
                const v = g.round_history[i]?.[p];
                return `<td>${(v !== undefined) ? ((v > 0 ? '+' : '') + v) : ''}</td>`;
            }).join('');
            tbody += `<tr><th>${String(i + 1).padStart(2,'0')}</th>${cells}</tr>`;
        }
        tbody += `</tbody>`;

        qs('#scoreboard').innerHTML = thead + tbody;
    }

    function renderPlayoff(g) {
        // Info bar
        const info = `<span>Playoff for ${g.playoff_base_score} points</span> - 
                      <span class="turn-info">${g.playoff_group[g.current_player_index]}'s Turn</span>`;
        qs('#info-bar').innerHTML = info;

        // Header row
        const headers = g.playoff_group.map((p, i) => {
            const cls = (i === g.current_player_index) ? 'current-player-header' : '';
            return `<th class="${cls}">${p}</th>`;
        }).join('');
        const thead = `<thead><tr><th>&nbsp;</th>${headers}</tr></thead>`;

        // Totals row (base score shown for all)
        const totals = g.playoff_group.map(() => {
            const s = g.playoff_base_score || 0;
            return `<td>${s > 0 ? '+' : ''}${s}</td>`;
        }).join('');
        let tbody = `<tbody><tr class="total-row"><th>Total</th>${totals}</tr>`;

        // Past TB rounds
        g.playoff_history.forEach((round_scores, idx) => {
            const cells = g.playoff_group.map(p => {
                const v = round_scores[p];
                return `<td>${(v !== undefined) ? ((v > 0 ? '+' : '') + v) : ''}</td>`;
            }).join('');
            tbody += `<tr><th>TB ${String(idx + 1).padStart(2,'0')}</th>${cells}</tr>`;
        });
        tbody += `</tbody>`;

        qs('#scoreboard').innerHTML = thead + tbody;
    }
    </script>
</body>
</html>
