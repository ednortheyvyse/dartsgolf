<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Darts Golf Scorer</title>
  <style>
	:root {
  	--bg-color:#1a1a1a; --text-color:#f0f0f0; --border-color:#444;
  	--primary-color:#E3292E;  /* RED (positive deltas) */
 	 --secondary-color:#309F6A; /* GREEN (negative deltas) */
 	 --accent-color:#F9DFBC;   /* SCORE CELL BACKGROUND */
 	 --accent-text-color:#000; /* running total text */
	}
    html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg-color);color:var(--text-color);height:100svh;display:flex;flex-direction:column;}
    body{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .container{flex:1;overflow-y:auto;padding:15px 2px;-ms-overflow-style:none;scrollbar-width:none;}
    .container::-webkit-scrollbar{display:none;}

    /* Bottom controls bar */
    .controls{flex-shrink:0;padding:10px;background:#000;border-top:2px solid var(--border-color);}
    .button-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:10px;}
    .button-grid.single{grid-template-columns:1fr;}
    .button-grid.duo{grid-template-columns:repeat(2,1fr);}
    .button-grid.duo form{margin:0;}
    @media (max-width: 420px){
      .button-grid.duo{grid-template-columns:1fr;}
    }
    .utility-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .button-grid button,.utility-grid button{width:100%;padding:20px 0;font-size:1.8em;font-weight:bold;border:none;border-radius:8px;cursor:pointer;touch-action:manipulation;}

    .score-btn.minus { background: var(--secondary-color); color:#fff; }
    .score-btn.plus  { background: var(--primary-color);  color:#fff; }
    .score-btn.zero  { background: #616161; color:#fff; }
    .undo-btn{background:#ff9800;color:#000;}
    .restart-btn{background:#f44336;color:#fff;}
    .export-btn{background:#2196f3;color:#fff;}

    .setup-screen { text-align:center; padding-top:4vh; max-width:900px; margin:0 auto; padding-left:8px; padding-right:8px; }
    .flash{margin:0 auto 16px;padding:12px 16px;border-radius:8px;border:1px solid #ff4d4d;background:#2a0000;color:#ffcccc;font-weight:600;}
    .setup-screen input[name="players"]{width:100%;min-height:50px;font-size:clamp(16px,4vw,22px);line-height:1.2;padding:12px 15px;box-sizing:border-box;margin:10px auto;border-radius:8px;border:1px solid var(--border-color);background:#101010;color:var(--text-color);}
    .setup-screen small{display:block;color:#bbb;margin-top:2px;margin-bottom:12px;}
    .setup-actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px;}
    .setup-screen button{padding:15px 30px;font-size:1.1em;background:var(--secondary-color);color:#fff;border:none;border-radius:8px;cursor:pointer;}
    .recent-wrap{margin-top:14px;}
    .recent-title{color:#ccc;font-size:.95em;margin-bottom:8px;}
    .chip-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
    .chip{background:#2b2b2b;color:#fff;border:1px solid #444;padding:8px 12px;border-radius:16px;cursor:pointer;user-select:none;font-size:.95em;}
    .chip.selected{background:var(--secondary-color);border-color:var(--secondary-color);}

    .scoreboard{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:20px;}
    .scoreboard th,.scoreboard td{border:1px solid var(--border-color);text-align:center;word-wrap:break-word;}
    .scoreboard thead th{font-size:1.2em;padding:8px 5px;line-height:1.4;vertical-align:middle;background:#333;}
    .scoreboard tbody th,.scoreboard tbody td{font-size:1.5em;vertical-align:middle;}
    .scoreboard tbody th{background:#2b2b2b;font-size:1.1em;padding:12px 5px;}
    .scoreboard tbody td{background:var(--accent-color);color:var(--accent-text-color);font-weight:bold;padding:12px 5px;}
    .scoreboard .total-row td{background:#333;color:#fff;} /* totals row stays neutral */

    /* These remain for other contexts but we won't apply them to round cells anymore */
    .scoreboard td.score-pos,
    .scoreboard .total-row td.score-pos { background: var(--primary-color); color:#fff; }
    .scoreboard td.score-neg,
    .scoreboard .total-row td.score-neg { background: var(--secondary-color); color:#fff; }
    .scoreboard td.score-zero,
    .scoreboard .total-row td.score-zero { background: #616161; color:#fff; }

    .current-player-header{color:var(--primary-color);font-weight:bold;}

    /* Header / info */
    .info-bar{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; margin-bottom:15px; }
    .round-count{ display:flex; align-items:flex-end; justify-content:center; gap:8px; line-height:1; margin-top:4px; flex-wrap:nowrap; }
    .round-label{ font-size: clamp(28px, 7vw, 56px); font-weight: 900; letter-spacing: 0.06em; }
    .round-number{ font-size: clamp(44px, 12vw, 96px); font-weight: 900; line-height: .9; color:#bbb; } /* grey current round number */
    .round-total{ font-size: clamp(10px, 2.8vw, 16px); font-weight: 700; opacity: .85; margin-left: 2px; align-self: flex-start; transform: translateY(-6px); }
    .turn-info{ font-size: clamp(18px, 4.2vw, 28px); font-weight: 700; color: var(--primary-color); text-align:center; }

    .scoreboard tr.current-row th { background:#3a3a3a; }

    /* --- Compact layout with true quarter-circle delta --- */
    .cell {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 58px;
      width: 100%;
      height: 100%;
    }

    /* Running total = black text, no pill background */
    .total-pill {
      color: #000;              /* BLACK */
      background: none;
      padding: 0;
      border-radius: 0;
      font-weight: 900;
      font-size: 1.2em;
      line-height: 1;
    }

    /* Bottom-right quarter-circle delta chip â€” sign-coloured; 0 = black */
    .delta-corner {
      position:absolute;
      right:0; bottom:0;
      height: 50%;
      aspect-ratio: 1 / 1;
      width: auto;
      border-top-left-radius: 100%;
      background:#000;     /* default; overridden below */
      color:#fff;
      display:flex; align-items:flex-end; justify-content:flex-end;
      padding: 2px 5px;
      font-weight: 900; font-size: .78em; line-height: 1;
      box-shadow: none;
      pointer-events: none;
    }
    .delta-corner.pos  { background: var(--primary-color); }   /* RED for + */
    .delta-corner.neg  { background: var(--secondary-color); } /* GREEN for - */
    .delta-corner.zero { background: #000; }                   /* BLACK for 0 */
    .delta-corner.hidden { opacity:0; }

    /* Remove inner padding on score cells so the wedge is truly flush */
    .scoreboard.playing tbody td,
    .scoreboard.final   tbody td { padding:0; }

    /* Ensure the .cell fills each td in those tables */
    .scoreboard.playing td .cell,
    .scoreboard.final   td .cell { width:100%; height:100%; }

    .homepage-dartboard,
    .final-standings-img{ display:block; width:auto; height:auto; max-width: min(92vw, 520px); max-height: 48vh; margin:0 auto 20px; object-fit: contain; }

    /* Floating score bubble */
    .score-bubble{
      position:fixed; z-index:9999; padding:6px 10px; border-radius:999px; font-weight:800; font-size:0.95em;
      white-space:nowrap; pointer-events:none; box-shadow:0 6px 16px rgba(0,0,0,0.35);
      transform:translate(-50%, 0) scale(0.95); opacity:0; animation:floatUp 900ms ease-out forwards;
      will-change: transform, opacity;
    }
    .score-bubble.pos  { background: var(--primary-color);  color:#fff; }
    .score-bubble.neg  { background: var(--secondary-color);color:#fff; }
    .score-bubble.zero { background: #000;                  color:#fff; } /* 0 = black */

    @keyframes floatUp{
      0%   { transform:translate(-50%, 8px)  scale(0.95); opacity:0; }
      15%  { transform:translate(-50%, 0px)  scale(1.00); opacity:1; }
      100% { transform:translate(-50%, -64px) scale(1.05); opacity:0; }
    }

    #final-capture{ overflow: visible; }
  </style>
</head>
<body>
  <div class="container">
    {% if game.phase == 'setup' %}
      <div class="setup-screen">
        <img src="{{ url_for('static', filename='images/dartsgolf4.png') }}" alt="Darts Golf Scorer Dartboard" class="homepage-dartboard">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, msg in messages %}
              <div class="flash">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        <form action="{{ url_for('start_game') }}" method="post">
          <input id="playersInput" type="text" name="players" placeholder="Enter player names, separated by commas" required>
          <small>Tip: tap chips to add/remove names. Names must be unique (case-insensitive).</small>
          <div class="setup-actions"><button type="submit">Start Game</button></div>
        </form>
        {% if game.recent_names %}
          <div class="recent-wrap">
            <div class="recent-title">Recent players</div>
            <div id="chipList" class="chip-list"></div>
          </div>
        {% endif %}
      </div>

    {% elif game.phase == 'playing' %}
      <div class="info-bar" id="info-bar">
        <div class="round-count">
          <span class="round-label">ROUND</span>
          <span class="round-number">{{ "%02d"|format(game.current_round) }}</span>
          <span class="round-total">/ 20</span>
        </div>
        <div class="turn-info">{{ game.players[game.current_player_index] }}'s Turn</div>
      </div>

      <!-- NOTE: 'playing' class -->
      <table class="scoreboard playing" id="scoreboard">
        <thead>
          <tr><th>&nbsp;</th>
            {% for p in game.players %}
              <th class="{{ 'current-player-header' if p == game.players[game.current_player_index] else '' }}">{{ p }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <!-- Totals row stays neutral; no sign colouring -->
          <tr class="total-row"><th>Total</th>
            {% for p in game.players %}
              {% set s = game.scores.get(p,0) %}
              <td>{% if s>0 %}+{% endif %}{{ s }}</td>
            {% endfor %}
          </tr>

          <tr class="current-row"><th>{{ "%02d"|format(game.current_round) }}</th>
            {% for p in game.players %}
              {% set v = game.round_history[game.current_round - 1].get(p) %}
              {% if v is not none %}
                {% set ns = namespace(total=0) %}
                {% for r in range(game.current_round) %}
                  {% set ns.total = ns.total + (game.round_history[r].get(p, 0)) %}
                {% endfor %}
                <td>
                  <div class="cell">
                    <span class="total-pill">{{ ns.total>0 and '+' or '' }}{{ ns.total }}</span>
                    <span class="delta-corner {{ 'pos' if v>0 else ('neg' if v<0 else 'zero') }}">
                      {{ v>0 and '+' or '' }}{{ v }}
                    </span>
                  </div>
                </td>
              {% else %}
                <td>
                  <div class="cell">
                    <span class="total-pill">0</span>
                    <span class="delta-corner hidden">0</span>
                  </div>
                </td>
              {% endif %}
            {% endfor %}
          </tr>

          {% for i in range(game.current_round - 1) | reverse %}
            <tr><th>{{ "%02d"|format(i + 1) }}</th>
              {% for p in game.players %}
                {% set v = game.round_history[i].get(p) %}
                {% if v is not none %}
                  {% set ns = namespace(total=0) %}
                  {% for r in range(i + 1) %}
                    {% set ns.total = ns.total + (game.round_history[r].get(p, 0)) %}
                  {% endfor %}
                  <td>
                    <div class="cell">
                      <span class="total-pill">{{ ns.total>0 and '+' or '' }}{{ ns.total }}</span>
                      <span class="delta-corner {{ 'pos' if v>0 else ('neg' if v<0 else 'zero') }}">
                        {{ v>0 and '+' or '' }}{{ v }}
                      </span>
                    </div>
                  </td>
                {% else %}
                  <td></td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif game.phase == 'playoff' %}
      <div class="info-bar" id="info-bar">
        <div class="round-count"><span class="round-label">TIE-BREAKER</span></div>
        <div class="turn-info">{{ game.playoff_group[game.current_player_index] }}'s Turn</div>
      </div>
      <table class="scoreboard" id="scoreboard">
        <thead>
          <tr><th>&nbsp;</th>
            {% for p in game.playoff_group %}
              <th class="{{ 'current-player-header' if p == game.playoff_group[game.current_player_index] else '' }}">{{ p }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <!-- Base playoff totals neutral -->
          <tr class="total-row"><th>Total</th>
            {% for _ in game.playoff_group %}
              {% set s = game.playoff_base_score %}
              <td>{% if s>0 %}+{% endif %}{{ s }}</td>
            {% endfor %}
          </tr>

          {% set total_tb = game.playoff_history|length %}
          {% for round_scores in game.playoff_history | reverse %}
            {% set tb_num = total_tb - loop.index0 %}
            <tr><th>TB {{ "%02d"|format(tb_num) }}</th>
              {% for p in game.playoff_group %}
                {% set v = round_scores.get(p) %}
                {% if v is not none %}
                  <td>{% if v>0 %}+{% endif %}{{ v }}</td>
                {% else %}
                  <td></td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif game.phase == 'final_ranking' %}
      <div id="final-capture">
        <div class="status-box">
          <img src="{{ url_for('static', filename='images/finalstanding1.png') }}" alt="Final Standings" class="final-standings-img">
        </div>

        <!-- NOTE: 'final' class -->
        <table class="scoreboard final" id="scoreboard">
          <thead>
            <tr><th>&nbsp;</th>
              {% for st in game.final_standings %}
                <th>{% set r=st.rank %}{% set sfx='th' %}
                    {% if r % 10 == 1 and r % 100 != 11 %}{% set sfx='st' %}{% endif %}
                    {% if r % 10 == 2 and r % 100 != 12 %}{% set sfx='nd' %}{% endif %}
                    {% if r % 10 == 3 and r % 100 != 13 %}{% set sfx='rd' %}{% endif %}
                    {{ r }}{{ sfx }}</th>
              {% endfor %}
            </tr>
            <tr><th>Player</th>
              {% for st in game.final_standings %}<th>{{ st.name }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            <!-- Final totals neutral -->
            <tr class="total-row"><th>Final</th>
              {% for st in game.final_standings %}
                {% set s = st.score %}
                <td>{% if s>0 %}+{% endif %}{{ s }}</td>
              {% endfor %}
            </tr>

            <!-- TB rows neutral (no sign colouring) -->
            {% for i in range(game.max_playoff_rounds, 0, -1) %}
              <tr><th>TB {{ "%02d"|format(i) }}</th>
                {% for st in game.final_standings %}
                  {% set hist = game.all_playoff_history.get(st.name, []) %}
                  {% if i <= hist|length %}
                    {% set v = hist[i-1] %}
                    <td>{% if v>0 %}+{% endif %}{{ v }}</td>
                  {% else %}
                    <td>-</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}

            {% for i in range(19, -1, -1) %}
              <tr><th>{{ "%02d"|format(i + 1) }}</th>
                {% for st in game.final_standings %}
                  {% set v = game.round_history[i].get(st.name) %}
                  {% if v is not none %}
                    {% set ns = namespace(total=0) %}
                    {% for r in range(i + 1) %}
                      {% set ns.total = ns.total + (game.round_history[r].get(st.name, 0)) %}
                    {% endfor %}
                    <td>
                      <div class="cell">
                        <span class="total-pill">{{ ns.total>0 and '+' or '' }}{{ ns.total }}</span>
                        <span class="delta-corner {{ 'pos' if v>0 else ('neg' if v<0 else 'zero') }}">
                          {{ v>0 and '+' or '' }}{{ v }}
                        </span>
                      </div>
                    </td>
                  {% else %}
                    <td></td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  {% if game.phase in ['playing','playoff'] %}
  <div class="controls">
    <div class="button-grid">
      <button type="button" class="score-btn minus" onclick="hit(-3, this)">-3</button>
      <button type="button" class="score-btn minus" onclick="hit(-2, this)">-2</button>
      <button type="button" class="score-btn minus" onclick="hit(-1, this)">-1</button>
      <button type="button" class="score-btn zero"  onclick="hit(0,  this)">0</button>
      <button type="button" class="score-btn plus"  onclick="hit(1,  this)">+1</button>
      <button type="button" class="score-btn plus"  onclick="hit(2,  this)">+2</button>
    </div>
    <div class="utility-grid">
      <button type="button" id="undoBtn" class="undo-btn" onclick="undo()" {{ 'disabled' if game.phase == 'playoff' else '' }}>Undo</button>
      <form action="{{ url_for('restart') }}" method="post" onsubmit="return confirm('Are you sure you want to restart the game?');">
        <button type="submit" class="restart-btn">Restart Game</button>
      </form>
    </div>
  </div>
  {% elif game.phase == 'final_ranking' %}
  <div class="controls">
    <div class="button-grid duo">
      <button type="button" class="export-btn" onclick="exportFinalPNG()">Export Scores</button>
      <form action="{{ url_for('restart') }}" method="post" onsubmit="return confirm('Start a new game?');">
        <button type="submit" class="restart-btn">Start New Game</button>
      </form>
    </div>
  </div>
  {% endif %}

  {% if game.phase == 'setup' and game.recent_names %}
  <script>
    var recentNames = {{ game.recent_names | tojson | safe }};
    var chipList = document.getElementById('chipList');
    var playersInput = document.getElementById('playersInput');

    function parseInputList(){ return playersInput.value.split(',').map(function(s){return s.trim();}).filter(Boolean); }
    function writeInputList(arr){ playersInput.value = arr.join(', '); }
    function toggleName(name){
      var list = parseInputList();
      var idx = -1;
      for (var i=0;i<list.length;i++){ if (list[i].toLowerCase() === name.toLowerCase()) { idx=i; break; } }
      if (idx >= 0) { list.splice(idx,1); } else { list.push(name); }
      writeInputList(list);
      var chip = document.querySelector('.chip[data-name="'+CSS.escape(name)+'"]');
      if (chip) chip.classList.toggle('selected');
    }

    if (chipList) {
      chipList.innerHTML = recentNames.map(function(n){
        return '<div class="chip" data-name="'+n+'" onclick="toggleName(\''+n.replace(/\'/g,"\\'")+'\')">'+n+'</div>';
      }).join('');
    }
  </script>
  {% endif %}

  {% if game.phase == 'playing' or game.phase == 'playoff' %}
  <script>
    function qs(s){return document.querySelector(s);}

    async function sendScore(val){
      var res = await fetch('{{ url_for("api_score") }}', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({score:val})
      });
      var data = await res.json(); if(!data.ok) return;
      var g = data.game; if(g.phase==='final_ranking'){ location.reload(); return; }
      renderGame(g);
    }
    async function undo(){
      var res = await fetch('{{ url_for("api_undo") }}',{method:'POST'});
      var data = await res.json(); if(!data.ok) return;
      renderGame(data.game);
    }
    function renderGame(g){
      if(g.phase==='playing'){ renderPlaying(g); var u=qs('#undoBtn'); if(u) u.removeAttribute('disabled'); }
      else if(g.phase==='playoff'){ renderPlayoff(g); var u2=qs('#undoBtn'); if(u2) u2.setAttribute('disabled','disabled'); }
    }

    function sign(v){ return v>0?'+':''; }

    function renderPlaying(g){
      qs('#info-bar').innerHTML =
        '<div class="round-count">'+
           '<span class="round-label">ROUND</span>'+
           '<span class="round-number">'+String(g.current_round).padStart(2,'0')+'</span>'+
           '<span class="round-total">/ 20</span>'+
         '</div>'+
         '<div class="turn-info">'+g.players[g.current_player_index]+"'s Turn</div>";

      var headers = g.players.map(function(p,i){return '<th class="'+(i===g.current_player_index?'current-player-header':'')+'">'+p+'</th>';}).join('');
      var thead = '<thead><tr><th>&nbsp;</th>'+headers+'</tr></thead>';

      // Totals row neutral
      var totals = g.players.map(function(p){
        var s = g.scores[p] || 0;
        return '<td>'+sign(s)+s+'</td>';
      }).join('');

      var tbody = '<tbody><tr class="total-row"><th>Total</th>'+totals+'</tr>';

      var curIdx = g.current_round - 1;
      var curRow = g.round_history[curIdx] || {};
      var currentCells = g.players.map(function(p){
        var v = curRow[p];
        if (typeof v === 'undefined') {
          return '<td><div class="cell">'+
                   '<span class="total-pill">0</span>'+
                   '<span class="delta-corner hidden">0</span>'+
                 '</div></td>';
        }
        var running = g.round_history.slice(0, g.current_round).reduce(function(sum, rh){ return sum + (rh[p]||0); }, 0);
        return '<td>'+
                 '<div class="cell">'+
                   '<span class="total-pill">'+sign(running)+running+'</span>'+
                   '<span class="delta-corner '+(v>0?'pos':(v<0?'neg':'zero'))+'">'+sign(v)+v+'</span>'+
                 '</div>'+
               '</td>';
      }).join('');
      tbody += '<tr class="current-row"><th>'+String(g.current_round).padStart(2,'0')+'</th>'+currentCells+'</tr>';

      for(var i=g.current_round-2;i>=0;i--){
        var row = g.round_history[i] || {};
        var cells = g.players.map(function(p){
          var v = row[p];
          if (typeof v === 'undefined') return '<td></td>';
          var running = g.round_history.slice(0, i+1).reduce(function(sum, rh){ return sum + (rh[p]||0); }, 0);
          return '<td>'+
                   '<div class="cell">'+
                     '<span class="total-pill">'+sign(running)+running+'</span>'+
                     '<span class="delta-corner '+(v>0?'pos':(v<0?'neg':'zero'))+'">'+sign(v)+v+'</span>'+
                   '</div>'+
                 '</td>';
        }).join('');
        tbody += '<tr><th>'+String(i+1).padStart(2,'0')+'</th>'+cells+'</tr>';
      }

      tbody += '</tbody>';
      qs('#scoreboard').innerHTML = thead+tbody;
    }

    function renderPlayoff(g){
      qs('#info-bar').innerHTML =
        '<div class="round-count"><span class="round-label">TIE-BREAKER</span></div>'+
        '<div class="turn-info">'+g.playoff_group[g.current_player_index]+"'s Turn</div>";
      var headers = g.playoff_group.map(function(p,i){return '<th class="'+(i===g.current_player_index?'current-player-header':'')+'">'+p+'</th>';}).join('');
      var thead = '<thead><tr><th>&nbsp;</th>'+headers+'</tr></thead>';

      // Base playoff totals neutral
      var totals = g.playoff_group.map(function(){ var s = g.playoff_base_score || 0; return '<td>'+sign(s)+s+'</td>'; }).join('');

      var tbody = '<tbody><tr class="total-row"><th>Total</th>'+totals+'</tr>';

      for (var idx = g.playoff_history.length - 1; idx >= 0; idx--) {
        var round_scores = g.playoff_history[idx] || {};
        var tbNum = idx + 1;
        var cells = g.playoff_group.map(function(p){
          var v = round_scores[p];
          if (typeof v === 'undefined') return '<td></td>';
          return '<td>'+sign(v)+v+'</td>';
        }).join('');
        tbody += '<tr><th>TB '+String(tbNum).padStart(2,'0')+'</th>'+cells+'</tr>';
      }

      tbody += '</tbody>';
      qs('#scoreboard').innerHTML = thead+tbody;
    }

    var LABELS = { "-3":"Triple Birdie","-2":"Double Birdie","-1":"Birdie","0":"Par","1":"Bogey","2":"Double Bogey" };
    function hit(val, el){ showBubbleFor(val, el); sendScore(val); }
    function showBubbleFor(val, el){
      var key = String(val), label = (typeof LABELS[key] !== 'undefined') ? LABELS[key] : key;
      var cls = val > 0 ? 'pos' : (val < 0 ? 'neg' : 'zero');
      var rect = el.getBoundingClientRect(), x = rect.left + (rect.width/2), y = rect.top - 6;
      var bubble = document.createElement('div'); bubble.className = 'score-bubble '+cls; bubble.textContent = label;
      bubble.style.left = x + 'px'; bubble.style.top = y + 'px'; document.body.appendChild(bubble);
      var remove = function(){ if (bubble && bubble.parentNode) bubble.parentNode.removeChild(bubble); };
      bubble.addEventListener('animationend', remove, { once:true }); setTimeout(remove, 1500);
    }
  </script>
  {% endif %}

  {% if game.phase == 'final_ranking' %}
  <script>
  function exportFinalPNG(){
    const el = document.getElementById('final-capture');
    if(!el){ alert('Nothing to export.'); return; }

    const rect = el.getBoundingClientRect();
    const MAX_W = 1100, MAX_H = 800;

    let w = Math.round(rect.width), h = Math.round(rect.height);
    const ar = rect.height / rect.width;
    if (w > MAX_W) { w = MAX_W; h = Math.round(w * ar); }
    if (h > MAX_H) { h = MAX_H; w = Math.round(h / ar); }

    const url = '{{ url_for("export_png") }}' + '?width=' + w + '&height=' + h;
    window.location.href = url;
  }
  </script>
  {% endif %}
</body>
</html>
