<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Darts Golf Scorer</title>
  <style>
    :root {
      --bg-color:#1a1a1a; --text-color:#f0f0f0; --border-color:#444;
      --primary-color:#d92727;  /* RED  (used for + scores) */
      --secondary-color:#008746;/* GREEN (used for - scores) */
      --accent-color:#e5d8b1; --accent-text-color:#000;
    }

    html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg-color);color:var(--text-color);height:100svh;display:flex;flex-direction:column;}
    body{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .container{flex:1;overflow-y:auto;padding:15px 2px;-ms-overflow-style:none;scrollbar-width:none;}
    .container::-webkit-scrollbar{display:none;}

    /* Bottom controls bar pinned to bottom of SCREEN */
    .controls{flex-shrink:0;padding:10px;background:#000;border-top:2px solid var(--border-color);}
    .button-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:10px;}
    .button-grid.single{grid-template-columns:1fr;}
    .utility-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .button-grid button,.utility-grid button{width:100%;padding:20px 0;font-size:1.8em;font-weight:bold;border:none;border-radius:8px;cursor:pointer;touch-action:manipulation;}

    /* Buttons: - = green, + = red, 0 = grey */
    .score-btn.minus { background: var(--secondary-color); color:#fff; }
    .score-btn.plus  { background: var(--primary-color);  color:#fff; }
    .score-btn.zero  { background: #616161; color:#fff; }
    .undo-btn{background:#ff9800;color:#000;}
    .restart-btn{background:#f44336;color:#fff;}
    .export-btn{background:#2196f3;color:#fff;}

    .setup-screen {
      text-align:center;
      padding-top:4vh;
      max-width:900px;
      margin:0 auto;
      padding-left:8px;
      padding-right:8px;
    }

    .setup-screen h1{margin-bottom:10px;}
    .flash{margin:0 auto 16px;padding:12px 16px;border-radius:8px;border:1px solid #ff4d4d;background:#2a0000;color:#ffcccc;font-weight:600;}
    .setup-screen input[name="players"]{width:100%;min-height:50px;font-size:clamp(16px,4vw,22px);line-height:1.2;padding:12px 15px;box-sizing:border-box;margin:10px auto;border-radius:8px;border:1px solid var(--border-color);background:#101010;color:var(--text-color);}
    .setup-screen small{display:block;color:#bbb;margin-top:2px;margin-bottom:12px;}
    .setup-actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px;}
    .setup-screen button{padding:15px 30px;font-size:1.1em;background:var(--secondary-color);color:#fff;border:none;border-radius:8px;cursor:pointer;}
    .recent-wrap{margin-top:14px;}
    .recent-title{color:#ccc;font-size:.95em;margin-bottom:8px;}
    .chip-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
    .chip{background:#2b2b2b;color:#fff;border:1px solid #444;padding:8px 12px;border-radius:16px;cursor:pointer;user-select:none;font-size:.95em;}
    .chip.selected{background:var(--secondary-color);border-color:var(--secondary-color);}

    .scoreboard{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:20px;}
    .scoreboard th,.scoreboard td{border:1px solid var(--border-color);text-align:center;word-wrap:break-word;}
    .scoreboard thead th{font-size:1.2em;padding:8px 5px;line-height:1.4;vertical-align:middle;background:#333;}
    .scoreboard tbody th,.scoreboard tbody td{font-size:1.5em;padding:12px 5px;vertical-align:middle;}
    .scoreboard tbody th{background:#2b2b2b;font-size:1.1em;}
    /* default background (overridden by per-score classes) */
    .scoreboard tbody td{background:var(--accent-color);color:var(--accent-text-color);font-weight:bold;}
    .scoreboard .total-row td{background:#333;color:var(--text-color);}

    /* Per-score coloring for cells (used for round result) */
    .scoreboard td.score-pos,
    .scoreboard .total-row td.score-pos { background: var(--primary-color); color:#fff; }
    .scoreboard td.score-neg,
    .scoreboard .total-row td.score-neg { background: var(--secondary-color); color:#fff; }
    .scoreboard td.score-zero,
    .scoreboard .total-row td.score-zero { background: #616161; color:#fff; }

    .current-player-header{color:var(--primary-color);font-weight:bold;}

    /* Centered header with large ROUND + number, tiny / 20, and medium turn */
    .info-bar{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin-bottom:15px;
    }
    .round-count{
      display:flex;
      align-items:flex-end;
      justify-content:center;
      gap:8px;
      line-height:1;
      margin-top:4px;
      flex-wrap:nowrap;
    }
    .round-label{
      font-size: clamp(28px, 7vw, 56px);
      font-weight: 900;
      letter-spacing: 0.06em;
    }
    .round-number{
      font-size: clamp(44px, 12vw, 96px);
      font-weight: 900;
      line-height: .9;
    }
    .round-total{
      font-size: clamp(10px, 2.8vw, 16px);
      font-weight: 700;
      opacity: .85;
      margin-left: 2px;
      align-self: flex-start;
      transform: translateY(-6px);
    }
    .turn-info{
      font-size: clamp(18px, 4.2vw, 28px);
      font-weight: 700;
      color: var(--primary-color);
      text-align:center;
    }

    /* Highlight the live/current round row */
    .scoreboard tr.current-row th { background:#3a3a3a; }

    /* Two-line cell; delta big, running total as pill (smaller) */
    .cell-wrap { display:flex; flex-direction:column; line-height:1.1; gap:4px; align-items:center; justify-content:center; }
    .cell-wrap .delta { font-weight:800; font-size:1em; }
    .cell-wrap .cum   { font-weight:700; font-size:.8em; }

    /* Running total pill */
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-weight:800; }
    .pill.pos  { background: var(--primary-color);  color:#fff; }
    .pill.neg  { background: var(--secondary-color);color:#fff; }
    .pill.zero { background: #616161;               color:#fff; }
    .pill.ghost { visibility:hidden; }

    /* Responsive images on setup + final pages */
    .homepage-dartboard,
    .final-standings-img{
      display:block;
      width:auto;
      height:auto;
      max-width: min(92vw, 520px);
      max-height: 48vh;
      margin:0 auto 20px;
      object-fit: contain;
    }

    /* Floating score bubble */
    .score-bubble{
      position:fixed;
      z-index:9999;
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:0.95em;
      white-space:nowrap;
      pointer-events:none;
      box-shadow:0 6px 16px rgba(0,0,0,0.35);
      transform:translate(-50%, 0) scale(0.95);
      opacity:0;
      animation:floatUp 900ms ease-out forwards;
      will-change: transform, opacity;
    }
    .score-bubble.pos  { background: var(--primary-color);  color:#fff; }
    .score-bubble.neg  { background: var(--secondary-color);color:#fff; }
    .score-bubble.zero { background: #616161;               color:#fff; }

    @keyframes floatUp{
      0%   { transform:translate(-50%, 8px)  scale(0.95); opacity:0; }
      15%  { transform:translate(-50%, 0px)  scale(1.00); opacity:1; }
      100% { transform:translate(-50%, -64px) scale(1.05); opacity:0; }
    }

    /* Export area wrapper (final screen) */
    #final-capture{ overflow: visible; }
  </style>
</head>
<body>
  <div class="container">
    {% if game.phase == 'setup' %}
      <div class="setup-screen">
        <img src="{{ url_for('static', filename='images/dartsgolf4.png') }}"
             alt="Darts Golf Scorer Dartboard"
             class="homepage-dartboard">

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, msg in messages %}
              <div class="flash">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('start_game') }}" method="post">
          <input id="playersInput" type="text" name="players" placeholder="Enter player names, separated by commas" required>
          <small>Tip: tap chips to add/remove names. Names must be unique (case-insensitive).</small>
          <div class="setup-actions">
            <button type="submit">Start Game</button>
          </div>
        </form>

        {% if game.recent_names %}
          <div class="recent-wrap">
            <div class="recent-title">Recent players</div>
            <div id="chipList" class="chip-list"></div>
          </div>
        {% endif %}
      </div>

    {% elif game.phase == 'playing' %}
      <div class="info-bar" id="info-bar">
        <div class="round-count">
          <span class="round-label">ROUND</span>
          <span class="round-number">{{ "%02d"|format(game.current_round) }}</span>
          <span class="round-total">/ 20</span>
        </div>
        <div class="turn-info">{{ game.players[game.current_player_index] }}'s Turn</div>
      </div>

      <table class="scoreboard" id="scoreboard">
        <thead>
          <tr><th>&nbsp;</th>
            {% for p in game.players %}
              <th class="{{ 'current-player-header' if p == game.players[game.current_player_index] else '' }}">{{ p }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr class="total-row"><th>Total</th>
            {% for p in game.players %}
              {% set s = game.scores.get(p,0) %}
              {% set cls = 'score-pos' if s>0 else ('score-neg' if s<0 else 'score-zero') %}
              <td class="{{ cls }}">{% if s>0 %}+{% endif %}{{ s }}</td>
            {% endfor %}
          </tr>

          <tr class="current-row"><th>{{ "%02d"|format(game.current_round) }}</th>
            {% for p in game.players %}
              {% set v = game.round_history[game.current_round - 1].get(p) %}
              {% if v is not none %}
                {% set ns = namespace(total=0) %}
                {% for r in range(game.current_round) %}
                  {% set ns.total = ns.total + (game.round_history[r].get(p, 0)) %}
                {% endfor %}
                {% set cell_cls = 'score-pos' if v>0 else ('score-neg' if v<0 else 'score-zero') %}
                {% set cum_cls  = 'pos' if ns.total>0 else ('neg' if ns.total<0 else 'zero') %}
                <td class="{{ cell_cls }}">
                  <div class="cell-wrap">
                    <div class="delta">{{ v>0 and '+' or '' }}{{ v }}</div>
                    <div class="cum"><span class="pill {{ cum_cls }}">T {{ ns.total>0 and '+' or '' }}{{ ns.total }}</span></div>
                  </div>
                </td>
              {% else %}
                <td>
                  <div class="cell-wrap">
                    <div class="delta ghostline">0</div>
                    <div class="cum"><span class="pill zero ghost">T 0</span></div>
                  </div>
                </td>
              {% endif %}
            {% endfor %}
          </tr>

          {% for i in range(game.current_round - 1) | reverse %}
            <tr><th>{{ "%02d"|format(i + 1) }}</th>
              {% for p in game.players %}
                {% set v = game.round_history[i].get(p) %}
                {% if v is not none %}
                  {% set ns = namespace(total=0) %}
                  {% for r in range(i + 1) %}
                    {% set ns.total = ns.total + (game.round_history[r].get(p, 0)) %}
                  {% endfor %}
                  {% set cell_cls = 'score-pos' if v>0 else ('score-neg' if v<0 else 'score-zero') %}
                  {% set cum_cls  = 'pos' if ns.total>0 else ('neg' if ns.total<0 else 'zero') %}
                  <td class="{{ cell_cls }}">
                    <div class="cell-wrap">
                      <div class="delta">{{ v>0 and '+' or '' }}{{ v }}</div>
                      <div class="cum"><span class="pill {{ cum_cls }}">T {{ ns.total>0 and '+' or '' }}{{ ns.total }}</span></div>
                    </div>
                  </td>
                {% else %}
                  <td></td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif game.phase == 'playoff' %}
      <div class="info-bar" id="info-bar">
        <div class="round-count">
          <span class="round-label">TIE-BREAKER</span>
        </div>
        <div class="turn-info">{{ game.playoff_group[game.current_player_index] }}'s Turn</div>
      </div>
      <table class="scoreboard" id="scoreboard">
        <thead>
          <tr><th>&nbsp;</th>
            {% for p in game.playoff_group %}
              <th class="{{ 'current-player-header' if p == game.playoff_group[game.current_player_index] else '' }}">{{ p }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr class="total-row"><th>Total</th>
            {% for _ in game.playoff_group %}
              {% set s = game.playoff_base_score %}
              {% set cls = 'score-pos' if s>0 else ('score-neg' if s<0 else 'score-zero') %}
              <td class="{{ cls }}">{% if s>0 %}+{% endif %}{{ s }}</td>
            {% endfor %}
          </tr>

          {% set total_tb = game.playoff_history|length %}
          {% for round_scores in game.playoff_history | reverse %}
            {% set tb_num = total_tb - loop.index0 %}
            <tr><th>TB {{ "%02d"|format(tb_num) }}</th>
              {% for p in game.playoff_group %}
                {% set v = round_scores.get(p) %}
                {% if v is not none %}
                  {% set cell_cls = 'score-pos' if v>0 else ('score-neg' if v<0 else 'score-zero') %}
                  <td class="{{ cell_cls }}">{{ v>0 and '+' or '' }}{{ v }}</td>
                {% else %}
                  <td></td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% elif game.phase == 'final_ranking' %}
      <div id="final-capture">
        <div class="status-box">
          <img src="{{ url_for('static', filename='images/finalstanding1.png') }}"
               alt="Final Standings"
               class="final-standings-img">
        </div>

        <table class="scoreboard" id="scoreboard">
          <thead>
            <tr><th>&nbsp;</th>
              {% for st in game.final_standings %}
                <th>{% set r=st.rank %}{% set sfx='th' %}
                    {% if r % 10 == 1 and r % 100 != 11 %}{% set sfx='st' %}{% endif %}
                    {% if r % 10 == 2 and r % 100 != 12 %}{% set sfx='nd' %}{% endif %}
                    {% if r % 10 == 3 and r % 100 != 13 %}{% set sfx='rd' %}{% endif %}
                    {{ r }}{{ sfx }}</th>
              {% endfor %}
            </tr>
            <tr><th>Player</th>
              {% for st in game.final_standings %}<th>{{ st.name }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr class="total-row"><th>Final</th>
              {% for st in game.final_standings %}
                {% set s = st.score %}
                {% set cls = 'score-pos' if s>0 else ('score-neg' if s<0 else 'score-zero') %}
                <td class="{{ cls }}">{% if s>0 %}+{% endif %}{{ s }}</td>
              {% endfor %}
            </tr>

            {% for i in range(game.max_playoff_rounds, 0, -1) %}
              <tr><th>TB {{ "%02d"|format(i) }}</th>
                {% for st in game.final_standings %}
                  {% set hist = game.all_playoff_history.get(st.name, []) %}
                  {% if i <= hist|length %}
                    {% set v = hist[i-1] %}
                    {% set cell_cls = 'score-pos' if v>0 else ('score-neg' if v<0 else 'score-zero') %}
                    <td class="{{ cell_cls }}">{% if v>0 %}+{% endif %}{{ v }}</td>
                  {% else %}
                    <td>-</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}

            {% for i in range(19, -1, -1) %}
              <tr><th>{{ "%02d"|format(i + 1) }}</th>
                {% for st in game.final_standings %}
                  {% set v = game.round_history[i].get(st.name) %}
                  {% if v is not none %}
                    {% set ns = namespace(total=0) %}
                    {% for r in range(i + 1) %}
                      {% set ns.total = ns.total + (game.round_history[r].get(st.name, 0)) %}
                    {% endfor %}
                    {% set cell_cls = 'score-pos' if v>0 else ('score-neg' if v<0 else 'score-zero') %}
                    {% set cum_cls  = 'pos' if ns.total>0 else ('neg' if ns.total<0 else 'zero') %}
                    <td class="{{ cell_cls }}">
                      <div class="cell-wrap">
                        <div class="delta">{{ v>0 and '+' or '' }}{{ v }}</div>
                        <div class="cum"><span class="pill {{ cum_cls }}">T {{ ns.total>0 and '+' or '' }}{{ ns.total }}</span></div>
                      </div>
                    </td>
                  {% else %}
                    <td></td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  {% if game.phase in ['playing','playoff'] %}
  <div class="controls">
    <div class="button-grid">
      <button type="button" class="score-btn minus" onclick="hit(-3, this)">-3</button>
      <button type="button" class="score-btn minus" onclick="hit(-2, this)">-2</button>
      <button type="button" class="score-btn minus" onclick="hit(-1, this)">-1</button>
      <button type="button" class="score-btn zero  " onclick="hit(0,  this)">0</button>
      <button type="button" class="score-btn plus  " onclick="hit(1,  this)">+1</button>
      <button type="button" class="score-btn plus  " onclick="hit(2,  this)">+2</button>
    </div>
    <div class="utility-grid">
      <button type="button" id="undoBtn" class="undo-btn" onclick="undo()" {{ 'disabled' if game.phase == 'playoff' else '' }}>Undo</button>
      <form action="{{ url_for('restart') }}" method="post" onsubmit="return confirm('Are you sure you want to restart the game?');">
        <button type="submit" class="restart-btn">Restart Game</button>
      </form>
    </div>
  </div>
  {% elif game.phase == 'final_ranking' %}
  <div class="controls">
    <div class="button-grid single">
      <button type="button" class="export-btn" style="grid-column:1 / -1;" onclick="exportFinalPNG()">Export PNG</button>
      <form action="{{ url_for('restart') }}" method="post" style="grid-column:1 / -1;" onsubmit="return confirm('Start a new game?');">
        <button type="submit" class="restart-btn">Start New Game</button>
      </form>
    </div>
  </div>
  {% endif %}

  {% if game.phase == 'setup' and game.recent_names %}
  <script>
    var recentNames = {{ game.recent_names | tojson | safe }};
    var chipList = document.getElementById('chipList');
    var playersInput = document.getElementById('playersInput');

    function parseInputList(){ return playersInput.value.split(',').map(function(s){return s.trim();}).filter(Boolean); }
    function writeInputList(arr){ playersInput.value = arr.join(', '); }
    function toggleName(name){
      var list = parseInputList();
      var idx = -1;
      for (var i=0;i<list.length;i++){ if (list[i].toLowerCase() === name.toLowerCase()) { idx=i; break; } }
      if (idx >= 0) { list.splice(idx,1); } else { list.push(name); }
      writeInputList(list);
      var chip = document.querySelector('.chip[data-name="'+CSS.escape(name)+'"]');
      if (chip) chip.classList.toggle('selected');
    }

    if (chipList) {
      chipList.innerHTML = recentNames.map(function(n){
        return '<div class="chip" data-name="'+n+'" onclick="toggleName(\''+n.replace(/'/g,"\\'")+'\')">'+n+'</div>';
      }).join('');
    }
  </script>
  {% endif %}

  {% if game.phase == 'playing' or game.phase == 'playoff' %}
  <script>
    function qs(s){return document.querySelector(s);}

    async function sendScore(val){
      var res = await fetch('{{ url_for("api_score") }}', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({score:val})
      });
      var data = await res.json(); if(!data.ok) return;
      var g = data.game; if(g.phase==='final_ranking'){ location.reload(); return; }
      renderGame(g);
    }
    async function undo(){
      var res = await fetch('{{ url_for("api_undo") }}',{method:'POST'});
      var data = await res.json(); if(!data.ok) return;
      renderGame(data.game);
    }
    function renderGame(g){
      if(g.phase==='playing'){ renderPlaying(g); var u=qs('#undoBtn'); if(u) u.removeAttribute('disabled'); }
      else if(g.phase==='playoff'){ renderPlayoff(g); var u2=qs('#undoBtn'); if(u2) u2.setAttribute('disabled','disabled'); }
    }

    function clsFor(v){
      if (v > 0) return 'score-pos';
      if (v < 0) return 'score-neg';
      return 'score-zero';
    }
    function pillFor(v){
      if (v > 0) return 'pos';
      if (v < 0) return 'neg';
      return 'zero';
    }
    function sign(v){ return v>0?'+':''; }

    function renderPlaying(g){
      qs('#info-bar').innerHTML =
        '<div class="round-count">'+
           '<span class="round-label">ROUND</span>'+
           '<span class="round-number">'+String(g.current_round).padStart(2,'0')+'</span>'+
           '<span class="round-total">/ 20</span>'+
         '</div>'+
         '<div class="turn-info">'+g.players[g.current_player_index]+"'s Turn</div>";

      var headers = g.players
        .map(function(p,i){return '<th class="'+(i===g.current_player_index?'current-player-header':'')+'">'+p+'</th>';})
        .join('');
      var thead = '<thead><tr><th>&nbsp;</th>'+headers+'</tr></thead>';

      var totals = g.players.map(function(p){
        var s = g.scores[p] || 0;
        return '<td class="'+clsFor(s)+'">'+sign(s)+s+'</td>';
      }).join('');

      var tbody = '<tbody><tr class="total-row"><th>Total</th>'+totals+'</tr>';

      var curIdx = g.current_round - 1;
      var curRow = g.round_history[curIdx] || {};
      var currentCells = g.players.map(function(p){
        var v = curRow[p];
        if (typeof v === 'undefined') {
          return '<td><div class="cell-wrap"><div class="delta ghostline">0</div><div class="cum"><span class="pill zero ghost">T 0</span></div></div></td>';
        }
        var running = g.round_history.slice(0, g.current_round)
          .reduce(function(sum, rh){ return sum + (rh[p]||0); }, 0);
        return '<td class="'+clsFor(v)+'">'+
                 '<div class="cell-wrap">'+
                   '<div class="delta">'+sign(v)+v+'</div>'+
                   '<div class="cum"><span class="pill '+pillFor(running)+'">T '+sign(running)+running+'</span></div>'+
                 '</div>'+
               '</td>';
      }).join('');
      tbody += '<tr class="current-row"><th>'+String(g.current_round).padStart(2,'0')+'</th>'+currentCells+'</tr>';

      for(var i=g.current_round-2;i>=0;i--){
        var row = g.round_history[i] || {};
        var cells = g.players.map(function(p){
          var v = row[p];
          if (typeof v === 'undefined') return '<td></td>';
          var running = g.round_history.slice(0, i+1)
            .reduce(function(sum, rh){ return sum + (rh[p]||0); }, 0);
          return '<td class="'+clsFor(v)+'">'+
                   '<div class="cell-wrap">'+
                     '<div class="delta">'+sign(v)+v+'</div>'+
                     '<div class="cum"><span class="pill '+pillFor(running)+'">T '+sign(running)+running+'</span></div>'+
                   '</div>'+
                 '</td>';
        }).join('');
        tbody += '<tr><th>'+String(i+1).padStart(2,'0')+'</th>'+cells+'</tr>';
      }

      tbody += '</tbody>';
      qs('#scoreboard').innerHTML = thead+tbody;
    }

    function renderPlayoff(g){
      qs('#info-bar').innerHTML =
        '<div class="round-count"><span class="round-label">TIE-BREAKER</span></div>'+
        '<div class="turn-info">'+g.playoff_group[g.current_player_index]+"'s Turn</div>";
      var headers = g.playoff_group.map(function(p,i){return '<th class="'+(i===g.current_player_index?'current-player-header':'')+'">'+p+'</th>';}).join('');
      var thead = '<thead><tr><th>&nbsp;</th>'+headers+'</tr></thead>';

      var totals = g.playoff_group.map(function(){
        var s = g.playoff_base_score || 0;
        return '<td class="'+clsFor(s)+'">'+sign(s)+s+'</td>';
      }).join('');

      var tbody = '<tbody><tr class="total-row"><th>Total</th>'+totals+'</tr>';

      for (var idx = g.playoff_history.length - 1; idx >= 0; idx--) {
        var round_scores = g.playoff_history[idx] || {};
        var tbNum = idx + 1;
        var cells = g.playoff_group.map(function(p){
          var v = round_scores[p];
          if (typeof v === 'undefined') return '<td></td>';
          return '<td class="'+clsFor(v)+'">'+sign(v)+v+'</td>';
        }).join('');
        tbody += '<tr><th>TB '+String(tbNum).padStart(2,'0')+'</th>'+cells+'</tr>';
      }

      tbody += '</tbody>';
      qs('#scoreboard').innerHTML = thead+tbody;
    }

    /* ---------- Floating bubble ---------- */
    var LABELS = {
      "-3": "Triple Birdie",
      "-2": "Double Birdie",
      "-1": "Birdie",
       "0": "Par",
       "1": "Bogey",
       "2": "Double Bogey"
    };
    function hit(val, el){
      showBubbleFor(val, el);
      sendScore(val);
    }
    function showBubbleFor(val, el){
      var key = String(val);
      var label = (typeof LABELS[key] !== 'undefined') ? LABELS[key] : key;
      var cls   = val > 0 ? 'pos' : (val < 0 ? 'neg' : 'zero');

      var rect = el.getBoundingClientRect();
      var x = rect.left + (rect.width / 2);
      var y = rect.top - 6;

      var bubble = document.createElement('div');
      bubble.className = 'score-bubble ' + cls;
      bubble.textContent = label;
      bubble.style.left = x + 'px';
      bubble.style.top  = y + 'px';

      document.body.appendChild(bubble);
      var remove = function(){ if (bubble && bubble.parentNode) bubble.parentNode.removeChild(bubble); };
      bubble.addEventListener('animationend', remove, { once:true });
      setTimeout(remove, 1500);
    }
  </script>
  {% endif %}

  {% if game.phase == 'final_ranking' %}
  <!-- Lightweight, robust client-side PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" integrity="sha256-wtWn3gS1e+JpMuqk2gD4mds0qShT2FhLJ5p9B7vJ2x0=" crossorigin="anonymous"></script>
  <script>
    function exportFinalPNG(){
      var target = document.getElementById('final-capture');
      if(!target){ alert('Nothing to export.'); return; }
      var bg = getComputedStyle(document.body).backgroundColor || '#1a1a1a';

      // SCALE=1 exports at on-screen size; bump to window.devicePixelRatio for sharper PNG.
      var SCALE = 1;

      if (typeof html2canvas === 'undefined') {
        alert('Export library failed to load.');
        return;
      }

      html2canvas(target, {
        backgroundColor: bg,
        useCORS: true,
        scale: SCALE,
        logging: false,
        removeContainer: true
      }).then(function(canvas){
        canvas.toBlob(function(pngBlob){
          if(!pngBlob){ alert('Export failed.'); return; }
          var a = document.createElement('a');
          a.href = URL.createObjectURL(pngBlob);
          a.download = 'final-standings.png';
          document.body.appendChild(a);
          a.click();
          setTimeout(function(){
            URL.revokeObjectURL(a.href);
            if (a.parentNode) a.parentNode.removeChild(a);
          }, 300);
        }, 'image/png', 1);
      }).catch(function(){
        alert('Could not render PNG in this browser.');
      });
    }
  </script>
  {% endif %}
</body>
</html>
