<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Darts Golf Scorer</title>
  <style>
    :root {
      --bg-color:#1a1a1a; --text-color:#f0f0f0; --border-color:#444;
      --primary-color:#d92727;  /* RED  (used for + scores) */
      --secondary-color:#008746;/* GREEN (used for - scores) */
      --accent-color:#e5d8b1; --accent-text-color:#000;
    }

    html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg-color);color:var(--text-color);height:100svh;display:flex;flex-direction:column;}
    body{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .container{flex:1;overflow-y:auto;padding:15px 2px;-ms-overflow-style:none;scrollbar-width:none;}
    .container::-webkit-scrollbar{display:none;}

    /* Bottom controls bar pinned to bottom of SCREEN */
    .controls{flex-shrink:0;padding:10px;background:#000;border-top:2px solid var(--border-color);}
    .button-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:10px;}
    .button-grid.single{grid-template-columns:1fr;}
    .utility-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .button-grid button,.utility-grid button{width:100%;padding:20px 0;font-size:1.8em;font-weight:bold;border:none;border-radius:8px;cursor:pointer;touch-action:manipulation;}

    /* Buttons: - = green, + = red, 0 = grey */
    .score-btn.minus { background: var(--secondary-color); color:#fff; }
    .score-btn.plus  { background: var(--primary-color);  color:#fff; }
    .score-btn.zero  { background: #616161; color:#fff; }
    .undo-btn{background:#ff9800;color:#000;}
    .restart-btn{background:#f44336;color:#fff;}

    .setup-screen{text-align:center;padding-top:14vh;max-width:900px;margin:0 auto;padding-left:8px;padding-right:8px;}
    .setup-screen h1{margin-bottom:10px;}
    .flash{margin:0 auto 16px;padding:12px 16px;border-radius:8px;border:1px solid #ff4d4d;background:#2a0000;color:#ffcccc;font-weight:600;}
    .setup-screen input[name="players"]{width:100%;min-height:50px;font-size:clamp(16px,4vw,22px);line-height:1.2;padding:12px 15px;box-sizing:border-box;margin:10px auto;border-radius:8px;border:1px solid var(--border-color);background:#101010;color:var(--text-color);}
    .setup-screen small{display:block;color:#bbb;margin-top:2px;margin-bottom:12px;}
    .setup-actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px;}
    .setup-screen button{padding:15px 30px;font-size:1.1em;background:var(--secondary-color);color:#fff;border:none;border-radius:8px;cursor:pointer;}
    .recent-wrap{margin-top:14px;}
    .recent-title{color:#ccc;font-size:.95em;margin-bottom:8px;}
    .chip-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
    .chip{background:#2b2b2b;color:#fff;border:1px solid #444;padding:8px 12px;border-radius:16px;cursor:pointer;user-select:none;font-size:.95em;}
    .chip.selected{background:var(--secondary-color);border-color:var(--secondary-color);}

    .scoreboard{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:20px;}
    .scoreboard th,.scoreboard td{border:1px solid var(--border-color);text-align:center;word-wrap:break-word;}
    .scoreboard thead th{font-size:1.2em;padding:8px 5px;line-height:1.4;vertical-align:middle;background:#333;}
    .scoreboard tbody th,.scoreboard tbody td{font-size:1.5em;padding:12px 5px;vertical-align:middle;}
    .scoreboard tbody th{background:#2b2b2b;font-size:1.1em;}
    /* default background (will be overridden by per-score classes) */
    .scoreboard tbody td{background:var(--accent-color);color:var(--accent-text-color);font-weight:bold;}
    .scoreboard .total-row td{background:#333;color:var(--text-color);}

    .current-player-header{color:var(--primary-color);font-weight:bold;}
    .info-bar{text-align:center;margin-bottom:15px;font-size:1.3em;font-weight:bold;}
    .info-bar .turn-info{color:var(--primary-color);}

    /* Per-score coloring for cells (overrides totals row style) */
    .scoreboard td.score-pos,
    .scoreboard .total-row td.score-pos { background: var(--primary-color); color:#fff; }

    .scoreboard td.score-neg,
    .scoreboard .total-row td.score-neg { background: var(--secondary-color); color:#fff; }

    .scoreboard td.score-zero,
    .scoreboard .total-row td.score-zero { background: #616161; color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    {# ---------------- SETUP ---------------- #}
    {% if game.phase == 'setup' %}
      <div class="setup-screen">
        <h1>Darts Golf Scorer</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, msg in messages %}
              <div class="flash">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('start_game') }}" method="post">
          <input id="playersInput" type="text" name="players" placeholder="Enter player names, separated by commas" required>
          <small>Tip: tap chips to add/remove names. Names must be unique (case-insensitive).</small>
          <div class="setup-actions">
            <button type="submit">Start Game</button>
          </div>
        </form>

        {% if game.recent_names %}
          <div class="recent-wrap">
            <div class="recent-title">Recent players</div>
            <div id="chipList" class="chip-list"></div>
          </div>
        {% endif %}
      </div>

    {# ---------------- PLAYING ---------------- #}
    {% elif game.phase == 'playing' %}
      <div class="info-bar" id="info-bar">
        <span>Round: {{ "%02d"|format(game.current_round) }} / 20</span> -
        <span class="turn-info">{{ game.players[game.current_player_index] }}'s Turn</span>
      </div>
      <table class="scoreboard" id="scoreboard">
        <thead>
          <tr><th>&nbsp;</th>
            {% for p in game.players %}
              <th class="{{ 'current-player-header' if p == game.players[game.current_player_index] else '' }}">{{ p }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr class="total-row"><th>Total</th>
            {% for p in game.players %}
              {% set s = game.scores.get(p,0) %}
              {% set cls = 'score-pos' if s>0 else ('score-neg' if s<0 else 'score-zero') %}
              <td class="{{ cls }}">{% if s>0 %}+{% endif %}{{ s }}</td>
            {% endfor %}
          </tr>
          {% for i in range(game.current_round - 1) | reverse %}
            <tr><th>{{ "%02d"|format(i + 1) }}</th>
              {% for p in game.players %}
                {% set v = game.round_history[i].get(p) %}
                {% set cls = '' %}
                {% if v is not none %}
                  {% if v>0 %}{% set cls='score-pos' %}{% elif v<0 %}{% set cls='score-neg' %}{% else %}{% set cls='score-zero' %}{% endif %}
                {% endif %}
                <td class="{{ cls }}">{% if v is not none %}{% if v>0 %}+{% endif %}{{ v }}{% endif %}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {# ---------------- PLAYOFF ---------------- #}
    {% elif game.phase == 'playoff' %}
      <div class="info-bar" id="info-bar">
        <span>Tie-Breaker</span> -
        <span class="turn-info">{{ game.playoff_group[game.current_player_index] }}'s Turn</span>
      </div>
      <table class="scoreboard" id="scoreboard">
        <thead>
          <tr><th>&nbsp;</th>
            {% for p in game.playoff_group %}
              <th class="{{ 'current-player-header' if p == game.playoff_group[game.current_player_index] else '' }}">{{ p }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr class="total-row"><th>Total</th>
            {% for _ in game.playoff_group %}
              {% set s = game.playoff_base_score %}
              {% set cls = 'score-pos' if s>0 else ('score-neg' if s<0 else 'score-zero') %}
              <td class="{{ cls }}">{% if s>0 %}+{% endif %}{{ s }}</td>
            {% endfor %}
          </tr>

          {# Newest TB on top #}
          {% set total_tb = game.playoff_history|length %}
          {% for round_scores in game.playoff_history | reverse %}
            {% set tb_num = total_tb - loop.index0 %}
            <tr><th>TB {{ "%02d"|format(tb_num) }}</th>
              {% for p in game.playoff_group %}
                {% set v = round_scores.get(p) %}
                {% set cls = '' %}
                {% if v is not none %}
                  {% if v>0 %}{% set cls='score-pos' %}{% elif v<0 %}{% set cls='score-neg' %}{% else %}{% set cls='score-zero' %}{% endif %}
                {% endif %}
                <td class="{{ cls }}">{% if v is not none %}{% if v>0 %}+{% endif %}{{ v }}{% endif %}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {# -------------- FINAL RANKING -------------- #}
    {% elif game.phase == 'final_ranking' %}
      <div class="status-box"><h1>Final Standings</h1></div>
      <table class="scoreboard" id="scoreboard">
        <thead>
          <tr><th>&nbsp;</th>
            {% for st in game.final_standings %}
              <th>{% set r=st.rank %}{% set sfx='th' %}
                  {% if r % 10 == 1 and r % 100 != 11 %}{% set sfx='st' %}{% endif %}
                  {% if r % 10 == 2 and r % 100 != 12 %}{% set sfx='nd' %}{% endif %}
                  {% if r % 10 == 3 and r % 100 != 13 %}{% set sfx='rd' %}{% endif %}
                  {{ r }}{{ sfx }}</th>
            {% endfor %}
          </tr>
          <tr><th>Player</th>
            {% for st in game.final_standings %}<th>{{ st.name }}</th>{% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr class="total-row"><th>Final</th>
            {% for st in game.final_standings %}
              {% set s = st.score %}
              {% set cls = 'score-pos' if s>0 else ('score-neg' if s<0 else 'score-zero') %}
              <td class="{{ cls }}">{% if s>0 %}+{% endif %}{{ s }}</td>
            {% endfor %}
          </tr>
          {% for i in range(game.max_playoff_rounds, 0, -1) %}
            <tr><th>TB {{ "%02d"|format(i) }}</th>
              {% for st in game.final_standings %}
                {% set hist = game.all_playoff_history.get(st.name, []) %}
                {% if i <= hist|length %}
                  {% set v = hist[i-1] %}
                  {% set cls = 'score-pos' if v>0 else ('score-neg' if v<0 else 'score-zero') %}
                  <td class="{{ cls }}">{% if v>0 %}+{% endif %}{{ v }}</td>
                {% else %}
                  <td>-</td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
          {% for i in range(19, -1, -1) %}
            <tr><th>{{ "%02d"|format(i + 1) }}</th>
              {% for st in game.final_standings %}
                {% set v = game.round_history[i].get(st.name) %}
                {% if v is not none %}
                  {% set cls = 'score-pos' if v>0 else ('score-neg' if v<0 else 'score-zero') %}
                  <td class="{{ cls }}">{% if v>0 %}+{% endif %}{{ v }}</td>
                {% else %}
                  <td></td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  {# ---- Controls pinned at bottom of SCREEN ---- #}
  {% if game.phase in ['playing','playoff'] %}
  <div class="controls">
    <div class="button-grid">
      <button type="button" class="score-btn minus" onclick="sendScore(-3)">-3</button>
      <button type="button" class="score-btn minus" onclick="sendScore(-2)">-2</button>
      <button type="button" class="score-btn minus" onclick="sendScore(-1)">-1</button>
      <button type="button" class="score-btn zero"  onclick="sendScore(0)">0</button>
      <button type="button" class="score-btn plus"  onclick="sendScore(1)">+1</button>
      <button type="button" class="score-btn plus"  onclick="sendScore(2)">+2</button>
    </div>
    <div class="utility-grid">
      <button type="button" id="undoBtn" class="undo-btn" onclick="undo()" {{ 'disabled' if game.phase == 'playoff' else '' }}>Undo</button>
      <form action="{{ url_for('restart') }}" method="post" onsubmit="return confirm('Are you sure you want to restart the game?');">
        <button type="submit" class="restart-btn">Restart Game</button>
      </form>
    </div>
  </div>

  {% elif game.phase == 'final_ranking' %}
  <div class="controls">
    <div class="button-grid single">
      <form action="{{ url_for('restart') }}" method="post" style="grid-column:1 / -1;" onsubmit="return confirm('Start a new game?');">
        <button type="submit" class="restart-btn">Start New Game</button>
      </form>
    </div>
  </div>
  {% endif %}

  {% if game.phase == 'setup' and game.recent_names %}
  <script>
    const recentNames = {{ game.recent_names | tojson | safe }};
    const chipList = document.getElementById('chipList');
    const playersInput = document.getElementById('playersInput');

    function parseInputList(){ return playersInput.value.split(',').map(s=>s.trim()).filter(Boolean); }
    function writeInputList(arr){ playersInput.value = arr.join(', '); }
    function toggleName(name){
      const list = parseInputList();
      const idx = list.findIndex(n => n.toLowerCase() === name.toLowerCase());
      if (idx >= 0) { list.splice(idx,1); } else { list.push(name); }
      writeInputList(list);
      const chip = document.querySelector(`.chip[data-name="${CSS.escape(name)}"]`);
      if (chip) chip.classList.toggle('selected');
    }

    if (chipList) {
      chipList.innerHTML = recentNames.map(n =>
        `<div class="chip" data-name="${n}" onclick="toggleName('${n.replace(/'/g,"\\'")}')">${n}</div>`
      ).join('');
    }
  </script>
  {% endif %}

  {% if game.phase == 'playing' or game.phase == 'playoff' %}
  <script>
    function qs(s){return document.querySelector(s);}

    async function sendScore(val){
      const res = await fetch('{{ url_for("api_score") }}', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({score:val})
      });
      const data = await res.json(); if(!data.ok) return;
      const g = data.game; if(g.phase==='final_ranking'){ location.reload(); return; }
      renderGame(g);
    }
    async function undo(){
      const res = await fetch('{{ url_for("api_undo") }}',{method:'POST'});
      const data = await res.json(); if(!data.ok) return;
      renderGame(data.game);
    }
    function renderGame(g){
      if(g.phase==='playing'){ renderPlaying(g); qs('#undoBtn')?.removeAttribute('disabled'); }
      else if(g.phase==='playoff'){ renderPlayoff(g); qs('#undoBtn')?.setAttribute('disabled','disabled'); }
    }

    function clsFor(v){
      if (v > 0) return 'score-pos';
      if (v < 0) return 'score-neg';
      return 'score-zero';
    }

    function renderPlaying(g){
      qs('#info-bar').innerHTML = `<span>Round: ${String(g.current_round).padStart(2,'0')} / 20</span> - <span class="turn-info">${g.players[g.current_player_index]}'s Turn</span>`;
      const headers = g.players.map((p,i)=>`<th class="${i===g.current_player_index?'current-player-header':''}">${p}</th>`).join('');
      const thead = `<thead><tr><th>&nbsp;</th>${headers}</tr></thead>`;

      const totals = g.players.map(p=>{
        const s = g.scores[p] || 0;
        return `<td class="${clsFor(s)}">${s>0?'+':''}${s}</td>`;
      }).join('');

      let tbody = `<tbody><tr class="total-row"><th>Total</th>${totals}</tr>`;
      for(let i=g.current_round-2;i>=0;i--){
        const cells = g.players.map(p=>{
          const v = g.round_history[i]?.[p];
          if (v === undefined) return `<td></td>`;
          return `<td class="${clsFor(v)}">${v>0?'+':''}${v}</td>`;
        }).join('');
        tbody += `<tr><th>${String(i+1).padStart(2,'0')}</th>${cells}</tr>`;
      }
      tbody += `</tbody>`;
      qs('#scoreboard').innerHTML = thead+tbody;
    }

    function renderPlayoff(g){
      qs('#info-bar').innerHTML = `<span>Tie-Breaker</span> - <span class="turn-info">${g.playoff_group[g.current_player_index]}'s Turn</span>`;
      const headers = g.playoff_group.map((p,i)=>`<th class="${i===g.current_player_index?'current-player-header':''}">${p}</th>`).join('');
      const thead = `<thead><tr><th>&nbsp;</th>${headers}</tr></thead>`;

      const totals = g.playoff_group.map(()=>{
        const s = g.playoff_base_score || 0;
        return `<td class="${clsFor(s)}">${s>0?'+':''}${s}</td>`;
      }).join('');

      let tbody = `<tbody><tr class="total-row"><th>Total</th>${totals}</tr>`;

      // Newest TB at top, labels stay chronological
      for (let idx = g.playoff_history.length - 1; idx >= 0; idx--) {
        const round_scores = g.playoff_history[idx];
        const tbNum = idx + 1;
        const cells = g.playoff_group.map(p=>{
          const v = round_scores[p];
          if (v === undefined) return `<td></td>`;
          return `<td class="${clsFor(v)}">${v>0?'+':''}${v}</td>`;
        }).join('');
        tbody += `<tr><th>TB ${String(tbNum).padStart(2,'0')}</th>${cells}</tr>`;
      }

      tbody += `</tbody>`;
      qs('#scoreboard').innerHTML = thead+tbody;
    }
  </script>
  {% endif %}
</body>
</html>
