<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Darts Golf Scorer</title>

  <!-- ===================== Favicon setup =====================
       Save your downloaded icon assets here:
       /static/icons/dartboard.svg
       /static/icons/dartboard-32.png
       /static/icons/dartboard-180.png
       /static/icons/dartboard-192.png
       /static/favicon.ico
  -->
  <link rel="icon" href="{{ url_for('static', filename='icons/dartboard.svg') }}" type="image/svg+xml">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/dartboard-32.png') }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/dartboard-192.png') }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/dartboard-180.png') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <meta name="theme-color" content="#182634">

  <style>
	:root {
  	--bg-color:#1a1a1a; --text-color:#f0f0f0; --border-color:#444;
  	--primary-color:#E3292E;  /* RED (positive deltas) */
 	 --secondary-color:#309F6A; /* GREEN (negative deltas) */
 	 --accent-color:#F9DFBC;   /* SCORE CELL BACKGROUND */
 	 --accent-text-color:#000; /* running total text */
	}
    html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg-color);color:var(--text-color);height:100svh;display:flex;flex-direction:column;}
    body{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .container{flex:1;overflow-y:auto;padding:15px 2px;-ms-overflow-style:none;scrollbar-width:none;}
    .container::-webkit-scrollbar{display:none;}

    /* Bottom controls bar */
    .controls{flex-shrink:0;padding:10px;background:#000;border-top:2px solid var(--border-color);}
    .button-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:10px;}
    .button-grid.single{grid-template-columns:1fr;}
    .button-grid.duo{grid-template-columns:repeat(2,1fr);}
    .button-grid.duo form{margin:0;}

    .utility-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;} /* baseline for non-playing variants */

    .button-grid button,.utility-grid button{
      width:100%;padding:20px 0;font-size:1.8em;font-weight:bold;border:none;border-radius:8px;cursor:pointer;touch-action:manipulation;white-space:nowrap;
    }

    .score-btn.minus { background: var(--secondary-color); color:#fff; }
    .score-btn.plus  { background: var(--primary-color);  color:#fff; }
    .score-btn.zero  { background: #616161; color:#fff; }
    .undo-btn{background:#ff9800;color:#000;}
    .restart-btn{background:#f44336;color:#fff;}
    .export-btn{background:#2196f3;color:#fff;}
    /* End uses same blue as export/view stats */
    .end-btn{background:#2196f3;color:#fff;}

    .setup-screen { text-align:center; padding-top:4vh; max-width:900px; margin:0 auto; padding-left:8px; padding-right:8px; }
    .flash{margin:0 auto 16px;padding:12px 16px;border-radius:8px;border:1px solid #ff4d4d;background:#2a0000;color:#ffcccc;font-weight:600;}
    .setup-screen input[name="players"]{width:100%;min-height:50px;font-size:clamp(16px,4vw,22px);line-height:1.2;padding:12px 15px;box-sizing:border-box;margin:10px auto;border-radius:8px;border:1px solid var(--border-color);background:#101010;color:var(--text-color);}
    .setup-screen small{display:block;color:#bbb;margin-top:2px;margin-bottom:12px;}
    .setup-actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px;}
    .setup-screen button{padding:15px 30px;font-size:1.1em;background:var(--secondary-color);color:#fff;border:none;border-radius:8px;cursor:pointer;}
    .recent-wrap{margin-top:14px;}
    .recent-title{color:#ccc;font-size:.95em;margin-bottom:8px;}
    .chip-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
    .chip{background:#2b2b2b;color:#fff;border:1px solid #444;padding:8px 12px;border-radius:16px;cursor:pointer;user-select:none;font-size:.95em;}
    .chip.selected{background:var(--secondary-color);border-color:var(--secondary-color);}

    .scoreboard{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:20px;}
    .scoreboard th,.scoreboard td{border:1px solid var(--border-color);text-align:center;word-wrap:break-word;}
    .scoreboard thead th{font-size:1.2em;padding:8px 5px;line-height:1.4;vertical-align:middle;background:#333;}
    .scoreboard tbody th,.scoreboard tbody td{font-size:1.5em;vertical-align:middle;}
    .scoreboard tbody th{background:#2b2b2b;font-size:1.1em;padding:12px 5px;}
    .scoreboard tbody td{background:var(--accent-color);color:var(--accent-text-color);font-weight:bold;padding:12px 5px;}
    .scoreboard .total-row td{background:#333;color:#fff;} /* totals row stays neutral */

    .current-player-header{color:var(--primary-color);font-weight:bold;}

    /* Header / info */
    .info-bar{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; margin-bottom:15px; }
    .round-count{ display:flex; align-items:flex-end; justify-content:center; gap:8px; line-height:1; margin-top:4px; flex-wrap:nowrap; }
    .round-label{ font-size: clamp(28px, 7vw, 56px); font-weight: 900; letter-spacing: 0.06em; }
    .round-number{ font-size: clamp(44px, 12vw, 96px); font-weight: 900; line-height: .9; color:#bbb; }
    .round-total{ font-size: clamp(10px, 2.8vw, 16px); font-weight: 700; opacity: .85; margin-left: 2px; align-self: flex-start; transform: translateY(-6px); }
    .turn-info{ font-size: clamp(18px, 4.2vw, 28px); font-weight: 700; color: var(--primary-color); text-align:center; }

    /* -------- End banner with outer padding wrapper -------- */
    .end-banner-wrap {
      background: #182634;      /* blue background surrounding the dashed box */
      border-radius: 12px;      /* slightly larger than the inner box radius */
      padding: 10px;            /* OUTER padding */
      margin-top: 12px;         /* spacing from surrounding content */
    }
    .end-banner{
      margin: 0;                /* wrapper handles outer spacing */
      padding: 12px 16px;       /* inner content padding */
      border: 1px dashed #2196f3;
      color: #fff;
      background: transparent;  /* wrapper supplies blue background */
      border-radius: 8px;
      font-weight: 700;
      text-align: center;
    }

    .scoreboard tr.current-row th { background:#3a3a3a; }

    /* --- Compact layout with true quarter-circle delta --- */
    .cell { position: relative; display: flex; align-items: center; justify-content: center; min-height: 58px; width: 100%; height: 100%; }
    .total-pill { color:#000; background:none; padding:0; border-radius:0; font-weight:900; font-size:1.2em; line-height:1; }

    .delta-corner { position:absolute; right:0; bottom:0; width:32px; height:32px; border-top-left-radius:100%; background:#000; color:#fff; display:flex; align-items:flex-end; justify-content:flex-end; font-weight:900; font-size:.75em; pointer-events:none; padding:2px 5px; box-sizing:border-box; overflow:hidden; line-height:1; }
    .delta-corner.pos  { background: var(--primary-color); }
    .delta-corner.neg  { background: var(--secondary-color); }
    .delta-corner.zero { background: #000; }
    .delta-corner.hidden { opacity: 0; }

    .scoreboard.playing tbody td, .scoreboard.final tbody td { padding:0; }
    .scoreboard.playing td .cell, .scoreboard.final td .cell { width:100%; height:100%; }

    .homepage-dartboard, .final-standings-img{ display:block; width:auto; height:auto; max-width: min(92vw, 520px); max-height: 48vh; margin:0 auto 20px; object-fit: contain; }

    .score-bubble{ position:fixed; z-index:9999; padding:6px 10px; border-radius:999px; font-weight:800; font-size:.95em; white-space:nowrap; pointer-events:none; box-shadow:0 6px 16px rgba(0,0,0,.35); transform:translate(-50%,0) scale(.95); opacity:0; animation:floatUp 900ms ease-out forwards; will-change:transform,opacity; }
    .score-bubble.pos{ background: var(--primary-color); color:#fff; }
    .score-bubble.neg{ background: var(--secondary-color); color:#fff; }
    .score-bubble.zero{ background:#000; color:#fff; }

    @keyframes floatUp{
      0%{ transform:translate(-50%,8px) scale(.95); opacity:0; }
      15%{ transform:translate(-50%,0) scale(1); opacity:1; }
      100%{ transform:translate(-50%,-64px) scale(1.05); opacity:0; }
    }

    #final-capture{ overflow: visible; }

    /* -------- In-app confirmation modal (replaces browser confirm) -------- */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; z-index:10000; padding:20px;
    }
    .modal{
      background:#111; border:1px solid var(--border-color); border-radius:12px;
      max-width:560px; width:100%; padding:18px; box-shadow:0 12px 36px rgba(0,0,0,.6);
    }
    .modal h3{ margin:0 0 8px; font-size:1.3em; }
    .modal p{ margin:0 0 16px; color:#ddd; }
    .modal-actions{ display:flex; gap:10px; justify-content:flex-end; }
    .modal-actions .btn{ padding:10px 16px; font-size:1.05em; font-weight:800; border:none; border-radius:8px; cursor:pointer; }
    .btn-cancel{ background:#444; color:#fff; }
    .btn-confirm{ background:#2196f3; color:#fff; }

    /* ----------------- Stats section styles (merged) ----------------- */
    h1 { text-align:center; font-size:2em; margin-bottom:24px; }
    .stat-block { background:#2b2b2b; border:1px solid var(--border-color); border-radius:12px; padding:16px; margin:0 12px 20px 12px; }
    .stat-title { font-size:1.2em; color:var(--accent-color); margin-bottom:8px; }
    .stat-value { font-size:1.5em; font-weight:bold; color:#fff; }
    .stat-player { color:var(--primary-color); font-weight:bold; margin-right:6px; }
    .stat-block small { display:block; margin-top:6px; color:#bdbdbd; font-size:0.9em; }

    /* --- Force Undo & End to always be horizontal --- */
    .utility-grid.playing{
      display:flex !important;  /* override grid for this variant */
      flex-wrap:nowrap;         /* never stack */
      gap:10px;
      align-items:stretch;
    }
    .utility-grid.playing > *{
      flex:1 1 0;               /* two equal columns that can shrink */
      min-width:0;              /* prevent overflow due to intrinsic width */
    }
    .utility-grid.playing button{
      white-space:nowrap;       /* keep label on one line */
      font-size: clamp(16px, 4.5vw, 28px);
      padding: clamp(12px, 3.5vw, 20px) 0;
    }

    /* --- Tiny toast notifications --- */
    .toast-container{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 10050;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none; /* clicks pass through */
    }
    .toast{
      pointer-events: auto;
      background: #222;
      color: #fff;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 800;
      font-size: 0.95em;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
    }
    .toast--error{ background:#3b1111; border-color:#6b1d1d; }
    .toast--success{ background:#113b25; border-color:#1d6b3a; }
    .toast--info{ background:#11233b; border-color:#1d3b6b; }
  </style>
</head>
<body>
  <div class="container">

    {% if show_stats %}
      <!-- ---------- STATS VIEW ---------- -->
      <h1>Game Stats</h1>

      <!-- Birdie streak rankings -->
      <div class="stat-block">
        <div class="stat-title">⛳ Birdie Streaks</div>
        {% if birdie_streak_ranking %}
          <ol>
            {% for row in birdie_streak_ranking %}
              <li>
                <span class="stat-player">{{ row.name }}</span>
                {{ row.streak }}
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">—</div>
          <small>No completed rounds yet.</small>
        {% endif %}
      </div>

      <!-- Bogey streak rankings -->
      <div class="stat-block">
        <div class="stat-title">🔥 Bogey Streaks</div>
        {% if bogey_streak_ranking %}
          <ol>
            {% for row in bogey_streak_ranking %}
              <li>
                <span class="stat-player">{{ row.name }}</span>
                {{ row.streak }}
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">—</div>
          <small>No completed rounds yet.</small>
        {% endif %}
      </div>

      <!-- Most birdies rankings -->
      <div class="stat-block">
        <div class="stat-title">🕊️ Total Birdies</div>
        {% if most_birdies_ranking %}
          <ol>
            {% for row in most_birdies_ranking %}
              <li>
                <span class="stat-player">{{ row.name }}</span>
                {{ row.count }}
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">—</div>
          <small>No completed rounds yet.</small>
        {% endif %}
      </div>

      <!-- Most bogeys rankings -->
      <div class="stat-block">
        <div class="stat-title">😬 Total Bogeys</div>
        {% if most_bogeys_ranking %}
          <ol>
            {% for row in most_bogeys_ranking %}
              <li>
                <span class="stat-player">{{ row.name }}</span>
                {{ row.count }}
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">—</div>
          <small>No completed rounds yet.</small>
        {% endif %}
      </div>

      <!-- Average score rankings -->
      <div class="stat-block">
        <div class="stat-title">📊 Average Scores</div>
        {% if average_ranking %}
          <ol>
            {% for row in average_ranking %}
              <li>
                <span class="stat-player">{{ row.name }}</span>
                {{ "%+.2f"|format(row.average) }}
                <small style="display:inline; opacity:.8;">(over {{ row.rounds }} rounds)</small>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">—</div>
          <small>No completed rounds yet.</small>
        {% endif %}
      </div>

      <!-- Comeback rankings -->
      <div class="stat-block">
        <div class="stat-title">↩️ Biggest Comebacks</div>
        {% if comeback_ranking %}
          <ol>
            {% for cb in comeback_ranking %}
              <li>
                <span class="stat-player">{{ cb.player }}</span>
                {{ cb.improvement }} saved
                <small style="display:block; margin-left:6px;">
                  from {{ "%+d"|format(cb.from_score) }} on Round {{ cb.from_round }}
                  to {{ "%+d"|format(cb.to_score) }} on Round {{ cb.to_round }}
                </small>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">—</div>
          <small>No positive improvements detected.</small>
        {% endif %}
      </div>

    {% else %}
      <!-- ---------- NORMAL INDEX VIEWS (setup / playing / playoff / final) ---------- -->
      {% if game.phase == 'setup' %}
        <div class="setup-screen">
          <img src="{{ url_for('static', filename='images/dartsgolf4.png') }}" alt="Darts Golf Scorer Dartboard" class="homepage-dartboard">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, msg in messages %}
                <div class="flash">{{ msg }}</div>
              {% endfor %}
            {% endif %}
          {% endwith %}
          <form action="{{ url_for('start_game') }}" method="post">
            <input id="playersInput" type="text" name="players" placeholder="Enter player names, separated by commas" required>
            <small>Tip: tap chips to add/remove names. Names must be unique (case-insensitive).</small>
            <div class="setup-actions"><button type="submit">Start Game</button></div>
          </form>
          {% if game.recent_names %}
            <div class="recent-wrap">
              <div class="recent-title">Recent players</div>
              <div id="chipList" class="chip-list"></div>
            </div>
          {% endif %}
        </div>

      {% elif game.phase == 'playing' %}
        <div class="info-bar" id="info-bar">
          <div class="round-count">
            <span class="round-label">ROUND</span>
            <span class="round-number">{{ "%02d"|format(game.current_round) }}</span>
            <span class="round-total">/ 20</span>
          </div>
          <div class="turn-info">{{ game.players[game.current_player_index] }}'s Turn</div>

          {% if game.end_after_round %}
            <div class="end-banner-wrap">
              <div class="end-banner">
                Game will end after this round. Finish all players this round to finalize and run tie-breakers.
              </div>
            </div>
          {% endif %}
        </div>

        <table class="scoreboard playing" id="scoreboard">
          <thead>
            <tr><th>&nbsp;</th>
              {% for p in game.players %}
                <th class="{{ 'current-player-header' if p == game.players[game.current_player_index] else '' }}">{{ p }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr class="total-row"><th>Total</th>
              {% for p in game.players %}
                {% set s = game.scores.get(p,0) %}
                <td>{% if s>0 %}+{% endif %}{{ s }}</td>
              {% endfor %}
            </tr>

            <tr class="current-row"><th>{{ "%02d"|format(game.current_round) }}</th>
              {% for p in game.players %}
                {% set v = game.round_history[game.current_round - 1].get(p) %}
                {% if v is not none %}
                  {% set ns = namespace(total=0) %}
                  {% for r in range(game.current_round) %}
                    {% set ns.total = ns.total + (game.round_history[r].get(p, 0)) %}
                  {% endfor %}
                  <td>
                    <div class="cell">
                      <span class="total-pill">{{ ns.total>0 and '+' or '' }}{{ ns.total }}</span>
                      <span class="delta-corner {{ 'pos' if v>0 else ('neg' if v<0 else 'zero') }}">
                        {{ v>0 and '+' or '' }}{{ v }}
                      </span>
                    </div>
                  </td>
                {% else %}
                  <td>
                    <div class="cell">
                      <span class="total-pill">0</span>
                      <span class="delta-corner hidden">0</span>
                    </div>
                  </td>
                {% endif %}
              {% endfor %}
            </tr>

            {% for i in range(game.current_round - 1) | reverse %}
              <tr><th>{{ "%02d"|format(i + 1) }}</th>
                {% for p in game.players %}
                  {% set v = game.round_history[i].get(p) %}
                  {% if v is not none %}
                    {% set ns = namespace(total=0) %}
                    {% for r in range(i + 1) %}
                      {% set ns.total = ns.total + (game.round_history[r].get(p, 0)) %}
                    {% endfor %}
                    <td>
                      <div class="cell">
                        <span class="total-pill">{{ ns.total>0 and '+' or '' }}{{ ns.total }}</span>
                        <span class="delta-corner {{ 'pos' if v>0 else ('neg' if v<0 else 'zero') }}">
                          {{ v>0 and '+' or '' }}{{ v }}
                        </span>
                      </div>
                    </td>
                  {% else %}
                    <td></td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>

      {% elif game.phase == 'playoff' %}
        <div class="info-bar" id="info-bar">
          <div class="round-count"><span class="round-label">TIE-BREAKER</span></div>
          <div class="turn-info">{{ game.playoff_group[game.current_player_index] }}'s Turn</div>
        </div>
        <table class="scoreboard" id="scoreboard">
          <thead>
            <tr><th>&nbsp;</th>
              {% for p in game.playoff_group %}
                <th class="{{ 'current-player-header' if p == game.playoff_group[game.current_player_index] else '' }}">{{ p }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr class="total-row"><th>Total</th>
              {% for _ in game.playoff_group %}
                {% set s = game.playoff_base_score %}
                <td>{% if s>0 %}+{% endif %}{{ s }}</td>
              {% endfor %}
            </tr>

            {% set total_tb = game.playoff_history|length %}
            {% for round_scores in game.playoff_history | reverse %}
              {% set tb_num = total_tb - loop.index0 %}
              <tr><th>TB {{ "%02d"|format(tb_num) }}</th>
                {% for p in game.playoff_group %}
                  {% set v = round_scores.get(p) %}
                  {% if v is not none %}
                    <td>{% if v>0 %}+{% endif %}{{ v }}</td>
                  {% else %}
                    <td></td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>

      {% elif game.phase == 'final_ranking' %}
        <div id="final-capture">
          <div class="status-box">
            <img src="{{ url_for('static', filename='images/finalstanding1.png') }}" alt="Final Standings" class="final-standings-img">
          </div>

          <table class="scoreboard final" id="scoreboard">
            <thead>
              <tr><th>&nbsp;</th>
                {% for st in game.final_standings %}
                  <th>{% set r=st.rank %}{% set sfx='th' %}
                      {% if r % 10 == 1 and r % 100 != 11 %}{% set sfx='st' %}{% endif %}
                      {% if r % 10 == 2 and r % 100 != 12 %}{% set sfx='nd' %}{% endif %}
                      {% if r % 10 == 3 and r % 100 != 13 %}{% set sfx='rd' %}{% endif %}
                      {{ r }}{{ sfx }}</th>
                {% endfor %}
              </tr>
              <tr><th>Player</th>
                {% for st in game.final_standings %}<th>{{ st.name }}</th>{% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr class="total-row"><th>Final</th>
                {% for st in game.final_standings %}
                  {% set s = st.score %}
                  <td>{% if s>0 %}+{% endif %}{{ s }}</td>
                {% endfor %}
              </tr>

              {% for i in range(game.max_playoff_rounds, 0, -1) %}
                <tr><th>TB {{ "%02d"|format(i) }}</th>
                  {% for st in game.final_standings %}
                    {% set hist = game.all_playoff_history.get(st.name, []) %}
                    {% if i <= hist|length %}
                      {% set v = hist[i-1] %}
                      <td>{% if v>0 %}+{% endif %}{{ v }}</td>
                    {% else %}
                      <td>-</td>
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}

              {% set rp = game.rounds_played or 0 %}
              {% for i in range(rp - 1, -1, -1) %}
                <tr><th>{{ "%02d"|format(i + 1) }}</th>
                  {% for st in game.final_standings %}
                    {% set v = game.round_history[i].get(st.name) %}
                    {% if v is not none %}
                      {% set ns = namespace(total=0) %}
                      {% for r in range(i + 1) %}
                        {% set ns.total = ns.total + (game.round_history[r].get(st.name, 0)) %}
                      {% endfor %}
                      <td>
                        <div class="cell">
                          <span class="total-pill">{{ ns.total>0 and '+' or '' }}{{ ns.total }}</span>
                          <span class="delta-corner {{ 'pos' if v>0 else ('neg' if v<0 else 'zero') }}">
                            {{ v>0 and '+' or '' }}{{ v }}
                          </span>
                        </div>
                      </td>
                    {% else %}
                      <td></td>
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- In-app confirmation modal (always available) -->
  <div id="confirmOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" aria-describedby="confirmMessage">
      <h3 id="confirmTitle">Confirm</h3>
      <p id="confirmMessage">Are you sure?</p>
      <div class="modal-actions">
        <button type="button" class="btn btn-cancel" id="confirmCancelBtn">Cancel</button>
        <button type="button" class="btn btn-confirm" id="confirmOkBtn">OK</button>
      </div>
    </div>
  </div>

  <!-- Toast host -->
  <div id="toastHost" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Inject initial game state for optimistic updates -->
  <script>
    window.__gameCache = {{ game | tojson | safe }};
  </script>

  <!-- Global confirm helper (replaces window.confirm) -->
  <script>
    (function(){
      const overlay = document.getElementById('confirmOverlay');
      const titleEl = document.getElementById('confirmTitle');
      const msgEl = document.getElementById('confirmMessage');
      const okBtn = document.getElementById('confirmOkBtn');
      const cancelBtn = document.getElementById('confirmCancelBtn');
      let resolver = null;

      function openModal(opts){
        const { title='Confirm', message='Are you sure?', okText='OK', cancelText='Cancel' } = opts || {};
        titleEl.textContent = title;
        msgEl.textContent = message;
        okBtn.textContent = okText;
        cancelBtn.textContent = cancelText;
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        setTimeout(()=> okBtn.focus(), 0);
        return new Promise(resolve => { resolver = resolve; });
      }
      function closeModal(result){
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
        if (resolver){ const r = resolver; resolver = null; r(result); }
      }

      okBtn.addEventListener('click', ()=> closeModal(true));
      cancelBtn.addEventListener('click', ()=> closeModal(false));
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(false); });
      window.addEventListener('keydown', (e)=>{ if (overlay.style.display === 'flex' && e.key === 'Escape') closeModal(false); });

      // Expose globally
      window.showConfirmModal = openModal;
    })();
  </script>

  <!-- Toast helper -->
  <script>
    function showToast(message, type='info', ms=2200){
      const host = document.getElementById('toastHost');
      if(!host) return;
      const t = document.createElement('div');
      t.className = 'toast toast--' + type;
      t.textContent = message;
      host.appendChild(t);
      // animate in
      requestAnimationFrame(()=> t.classList.add('show'));
      // auto remove
      const remove = ()=> {
        t.classList.remove('show');
        setTimeout(()=> t.remove(), 200);
      };
      setTimeout(remove, ms);
      return remove; // in case you want to dismiss early
    }
  </script>

  {% if game.phase == 'setup' and game.recent_names and not show_stats %}
  <script>
    var recentNames = {{ game.recent_names | tojson | safe }};
    var chipList = document.getElementById('chipList');
    var playersInput = document.getElementById('playersInput');

    function parseInputList(){ return playersInput.value.split(',').map(function(s){return s.trim();}).filter(Boolean); }
    function writeInputList(arr){ playersInput.value = arr.join(', '); }
    function toggleName(name){
      var list = parseInputList();
      var idx = -1;
      for (var i=0;i<list.length;i++){ if (list[i].toLowerCase() === name.toLowerCase()) { idx=i; break; } }
      if (idx >= 0) { list.splice(idx,1); } else { list.push(name); }
      writeInputList(list);
      var chip = document.querySelector('.chip[data-name="'+CSS.escape(name)+'"]');
      if (chip) chip.classList.toggle('selected');
    }

    if (chipList) {
      chipList.innerHTML = recentNames.map(function(n){
        return '<div class="chip" data-name="'+n+'" onclick="toggleName(\''+n.replace(/\'/g,"\\'")+'\')">'+n+'</div>';
      }).join('');
    }
  </script>
  {% endif %}

  {% if (game.phase == 'playing' or game.phase == 'playoff') and not show_stats %}
  <script>
    function qs(s){return document.querySelector(s);}

    // Track current end state for confirm prompts
    let END_ACTIVE = {{ 'true' if game.end_after_round else 'false' }};

    function updateEndButtonLabel(active){
      var b = document.getElementById('endBtn');
      if (b) b.textContent = active ? 'Cancel' : 'End';
    }

    // ---- Anti-flicker sequencing + micro-batching ----
    let __opCounter = 0;        // increases for each local action (score/undo)
    let __lastCommittedOp = 0;  // last opId we've applied from the server
    let __applyTimer = null;    // tiny debounce timer for applying server state

    function scheduleApplyFromServer(game, opId, force = false) {
      // Force = apply even if stale (e.g., phase transition into playoff/final)
      if (force) {
        __lastCommittedOp = Math.max(__lastCommittedOp, opId);
        window.__gameCache = game;
        renderGame(game);
        return;
      }
      // Ignore stale responses
      if (opId < __lastCommittedOp) return;

      // Micro-batch: give ~40ms for newer responses to arrive
      if (__applyTimer) clearTimeout(__applyTimer);
      __applyTimer = setTimeout(() => {
        if (opId < __lastCommittedOp) return; // a newer op landed during the wait
        __lastCommittedOp = opId;
        window.__gameCache = game;
        renderGame(game);
      }, 40);
    }

    // Optimistic sendScore with op-aware gating to reduce flicker
    async function sendScore(val){
      const snapshot = window.__gameCache ? JSON.parse(JSON.stringify(window.__gameCache)) : null;
      const opId = ++__opCounter; // tag this action

      try{
        // 1) Optimistic local update
        if (window.__gameCache){
          const g = JSON.parse(JSON.stringify(window.__gameCache)); // clone

          if (g.phase === 'playing'){
            const pIdx   = g.current_player_index;
            const player = g.players[pIdx];
            const roundI = g.current_round - 1;

            g.round_history[roundI] = g.round_history[roundI] || {};
            g.scores[player] = (g.scores[player] || 0) + val;
            g.round_history[roundI][player] = val;

            // mirror server undo_history push
            g.undo_history = g.undo_history || [];
            g.undo_history.push({ player_index: pIdx, score_change: val });

            // advance cursor locally unless server is about to end/transition
            const lastIndex = g.players.length - 1;
            const wasLast   = pIdx === lastIndex;
            if (!(wasLast && g.end_after_round)) {
              g.current_player_index = wasLast ? 0 : pIdx + 1;
              if (wasLast) g.current_round += 1;
            }
          } else if (g.phase === 'playoff'){
            // minimal optimistic feedback for TB
            const pIdx = g.current_player_index;
            const player = g.playoff_group[pIdx];
            g.playoff_round_scores = g.playoff_round_scores || {};
            g.playoff_round_scores[player] = val;
            g.current_player_index = Math.min(pIdx + 1, g.playoff_group.length - 1);
          }

          window.__gameCache = g;
          renderGame(g); // instant paint
        }

        // 2) Server call
        const res = await fetch('{{ url_for("api_score") }}', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({score:val})
        });

        if (!res.ok){
          // Only roll back if NO newer ops happened since this one
          if (__opCounter === opId && snapshot){
            window.__gameCache = snapshot;
            renderGame(snapshot);
            __lastCommittedOp = opId;
          }
          showToast('Couldn’t save score — connection error', 'error');
          return;
        }

        const data = await res.json();
        if (!data.ok){
          if (__opCounter === opId && snapshot){
            window.__gameCache = snapshot;
            renderGame(snapshot);
            __lastCommittedOp = opId;
          }
          showToast('Couldn’t save score — server rejected', 'error');
          return;
        }

        // If server says final, reload to SSR final view to keep code simple
        if (data.game.phase === 'final_ranking') {
          location.reload();
          return;
        }

        const force = (data.game.phase !== 'playing' || window.__gameCache.phase !== 'playing');
        scheduleApplyFromServer(data.game, opId, force);
      }catch(e){
        if (__opCounter === opId && snapshot){
          window.__gameCache = snapshot;
          renderGame(snapshot);
          __lastCommittedOp = opId;
        }
        showToast('Couldn’t save score — offline?', 'error');
        console.error('Score sync failed', e);
      }
    }

    // Optimistic Undo with op-aware gating to reduce flicker
    async function undo(){
      const g0 = window.__gameCache;
      if (!g0 || g0.phase !== 'playing'){
        showToast('Undo not available now', 'info', 1400);
        return;
      }
      if (!g0.undo_history || !g0.undo_history.length){
        showToast('Nothing to undo', 'info', 1400);
        return;
      }

      const snapshot = JSON.parse(JSON.stringify(g0));
      const opId = ++__opCounter;

      try{
        // ---- Optimistic revert (mirror server _apply_undo) ----
        const g = JSON.parse(JSON.stringify(g0));
        const n = g.players.length;

        const last_move = g.undo_history.pop();
        const prev_idx = (g.current_player_index - 1 + n) % n;
        g.current_player_index = prev_idx;

        if (prev_idx === n - 1){
          g.current_round = Math.max(1, g.current_round - 1);
        }

        const player_to_undo = g.players[prev_idx];
        const current_round_index = g.current_round - 1;
        g.scores[player_to_undo] = (g.scores[player_to_undo] || 0) - (last_move.score_change || 0);
        g.round_history[current_round_index] = g.round_history[current_round_index] || {};
        delete g.round_history[current_round_index][player_to_undo];

        window.__gameCache = g;
        renderGame(g); // instant UI revert

        // ---- Server call ----
        const res = await fetch('{{ url_for("api_undo") }}', { method:'POST' });

        if (!res.ok){
          if (__opCounter === opId){
            window.__gameCache = snapshot;
            renderGame(snapshot);
            __lastCommittedOp = opId;
          }
          showToast('Undo failed — connection error', 'error');
          return;
        }
        const data = await res.json();
        if (!data.ok){
          if (__opCounter === opId){
            window.__gameCache = snapshot;
            renderGame(snapshot);
            __lastCommittedOp = opId;
          }
          showToast('Undo failed — server rejected', 'error');
          return;
        }

        const force = (data.game.phase !== 'playing' || window.__gameCache.phase !== 'playing');
        scheduleApplyFromServer(data.game, opId, force);
      }catch(e){
        if (__opCounter === opId){
          window.__gameCache = snapshot;
          renderGame(snapshot);
          __lastCommittedOp = opId;
        }
        showToast('Undo failed — offline?', 'error');
        console.error('Undo sync failed', e);
      }
    }

    async function toggleEnd(){
      // Confirm based on current state using in-app modal
      if (!END_ACTIVE) {
        const ok = await window.showConfirmModal({
          title: 'End',
          message: 'The game will end after ALL players finish THIS round. Continue?',
          okText: 'End',
          cancelText: 'Cancel'
        });
        if (!ok) return;
      } else {
        const ok = await window.showConfirmModal({
          title: 'Cancel End',
          message: 'The game will continue normally after this round. Continue?',
          okText: 'Cancel End',
          cancelText: 'Keep Ending'
        });
        if (!ok) return;
      }
      var res = await fetch('{{ url_for("api_end_after_round") }}',{method:'POST'});
      var data = await res.json(); if(!data.ok) return;
      window.__gameCache = data.game;
      renderGame(data.game);
    }

    function renderGame(g){
      if(g.phase==='playing'){ renderPlaying(g); var u=qs('#undoBtn'); if(u) u.removeAttribute('disabled'); }
      else if(g.phase==='playoff'){ renderPlayoff(g); var u2=qs('#undoBtn'); if(u2) u2.setAttribute('disabled','disabled'); }
      END_ACTIVE = !!g.end_after_round; // keep in sync
      updateEndButtonLabel(END_ACTIVE);
    }

    function sign(v){ return v>0?'+':''; }

    function renderPlaying(g){
      var banner = g.end_after_round
        ? '<div class="end-banner-wrap"><div class="end-banner">Game will end after this round. Finish all players this round to finalize and run tie-breakers.</div></div>'
        : '';
      qs('#info-bar').innerHTML =
        '<div class="round-count">'+
           '<span class="round-label">ROUND</span>'+
           '<span class="round-number">'+String(g.current_round).padStart(2,'0')+'</span>'+
           '<span class="round-total">/ 20</span>'+
         '</div>'+
         '<div class="turn-info">'+g.players[g.current_player_index]+"'s Turn</div>"+banner;

      var headers = g.players.map(function(p,i){return '<th class="'+(i===g.current_player_index?'current-player-header':'')+'">'+p+'</th>';}).join('');
      var thead = '<thead><tr><th>&nbsp;</th>'+headers+'</tr></thead>';

      var totals = g.players.map(function(p){
        var s = g.scores[p] || 0;
        return '<td>'+sign(s)+s+'</td>';
      }).join('');

      var tbody = '<tbody><tr class="total-row"><th>Total</th>'+totals+'</tr>';

      var curIdx = g.current_round - 1;
      var curRow = g.round_history[curIdx] || {};
      var currentCells = g.players.map(function(p){
        var v = curRow[p];
        if (typeof v === 'undefined') {
          return '<td><div class="cell">'+
                   '<span class="total-pill">0</span>'+
                   '<span class="delta-corner hidden">0</span>'+
                 '</div></td>';
        }
        var running = g.round_history.slice(0, g.current_round).reduce(function(sum, rh){ return sum + (rh[p]||0); }, 0);
        return '<td>'+
                 '<div class="cell">'+
                   '<span class="total-pill">'+sign(running)+running+'</span>'+
                   '<span class="delta-corner '+(v>0?'pos':(v<0?'neg':'zero'))+'">'+sign(v)+v+'</span>'+
                 '</div>'+
               '</td>';
      }).join('');
      tbody += '<tr class="current-row"><th>'+String(g.current_round).padStart(2,'0')+'</th>'+currentCells+'</tr>';

      for(var i=g.current_round-2;i>=0;i--){
        var row = g.round_history[i] || {};
        var cells = g.players.map(function(p){
          var v = row[p];
          if (typeof v === 'undefined') return '<td></td>';
          var running = g.round_history.slice(0, i+1).reduce(function(sum, rh){ return sum + (rh[p]||0); }, 0);
          return '<td>'+
                   '<div class="cell">'+
                     '<span class="total-pill">'+sign(running)+running+'</span>'+
                     '<span class="delta-corner '+(v>0?'pos':(v<0?'neg':'zero'))+'">'+sign(v)+v+'</span>'+
                   '</div>'+
                 '</td>';
        }).join('');
        tbody += '<tr><th>'+String(i+1).padStart(2,'0')+'</th>'+cells+'</tr>';
      }

      tbody += '</tbody>';
      qs('#scoreboard').innerHTML = thead+tbody;
    }

    function renderPlayoff(g){
      qs('#info-bar').innerHTML =
        '<div class="round-count"><span class="round-label">TIE-BREAKER</span></div>'+
        '<div class="turn-info">'+g.playoff_group[g.current_player_index]+"'s Turn</div>";
      var headers = g.playoff_group.map(function(p,i){return '<th class="'+(i===g.current_player_index?'current-player-header':'')+'">'+p+'</th>';}).join('');
      var thead = '<thead><tr><th>&nbsp;</th>'+headers+'</tr></thead>';

      var totals = g.playoff_group.map(function(){ var s = g.playoff_base_score || 0; return '<td>'+sign(s)+s+'</td>'; }).join('');

      var tbody = '<tbody><tr class="total-row"><th>Total</th>'+totals+'</tr>';

      for (var idx = g.playoff_history.length - 1; idx >= 0; idx--) {
        var round_scores = g.playoff_history[idx] || {};
        var tbNum = idx + 1;
        var cells = g.playoff_group.map(function(p){
          var v = round_scores[p];
          if (typeof v === 'undefined') return '<td></td>';
          return '<td>'+sign(v)+v+'</td>';
        }).join('');
        tbody += '<tr><th>TB '+String(tbNum).padStart(2,'0')+'</th>'+cells+'</tr>';
      }

      tbody += '</tbody>';
      qs('#scoreboard').innerHTML = thead+tbody;
    }

    var LABELS = { "-3":"Albatross","-2":"Eagle","-1":"Birdie","0":"Par","1":"Bogey","2":"Double Bogey" };
    function hit(val, el){ showBubbleFor(val, el); sendScore(val); }
    function showBubbleFor(val, el){
      var key = String(val), label = (typeof LABELS[key] !== 'undefined') ? LABELS[key] : key;
      var cls = val > 0 ? 'pos' : (val < 0 ? 'neg' : 'zero');
      var rect = el.getBoundingClientRect(), x = rect.left + (rect.width/2), y = rect.top - 6;
      var bubble = document.createElement('div'); bubble.className = 'score-bubble '+cls; bubble.textContent = label;
      bubble.style.left = x + 'px'; bubble.style.top = y + 'px'; document.body.appendChild(bubble);
      var remove = function(){ if (bubble && bubble.parentNode) bubble.parentNode.removeChild(bubble); };
      bubble.addEventListener('animationend', remove, { once:true }); setTimeout(remove, 1500);
    }

    // Ensure initial label matches state on load (in case of SSR state)
    updateEndButtonLabel(END_ACTIVE);
  </script>
  {% endif %}

  <!-- --------------- Controls (bottom bar) --------------- -->
  {% if show_stats %}
    <div class="controls">
      <div class="button-grid single">
        <a href="{{ url_for('index') }}">
          <button type="button" class="export-btn">Back to Final Standings</button>
        </a>
        <form id="restartForm" action="{{ url_for('restart') }}" method="post">
          <button type="button" id="restartBtn" class="restart-btn">Start New Game</button>
        </form>
      </div>
    </div>
  {% elif game.phase in ['playing','playoff'] %}
    <div class="controls">
      <!-- Score buttons -->
      <div class="button-grid">
        <button type="button" class="score-btn minus" onclick="hit(-3, this)">-3</button>
        <button type="button" class="score-btn minus" onclick="hit(-2, this)">-2</button>
        <button type="button" class="score-btn minus" onclick="hit(-1, this)">-1</button>
        <button type="button" class="score-btn zero"  onclick="hit(0,  this)">0</button>
        <button type="button" class="score-btn plus"  onclick="hit(1,  this)">+1</button>
        <button type="button" class="score-btn plus"  onclick="hit(2,  this)">+2</button>
      </div>

      <!-- Utility buttons: Undo | End / Cancel (always horizontal) -->
      <div class="utility-grid playing">
        <button type="button" id="undoBtn" class="undo-btn" onclick="undo()" {{ 'disabled' if game.phase == 'playoff' else '' }}>Undo</button>

        <button type="button" id="endBtn" class="end-btn" onclick="toggleEnd()">
          {{ 'Cancel' if game.end_after_round else 'End' }}
        </button>
      </div>
    </div>
  {% elif game.phase == 'final_ranking' %}
    <div class="controls">
      <div class="button-grid single">
        <a href="{{ url_for('stats') }}">
          <button type="button" class="export-btn">View Stats</button>
        </a>
        <form id="restartForm" action="{{ url_for('restart') }}" method="post">
          <button type="button" id="restartBtn" class="restart-btn">Start New Game</button>
        </form>
      </div>
    </div>
  {% endif %}

  <!-- Attach in-app confirmation for "Start New Game" wherever the button exists -->
  <script>
    (function(){
      var btn = document.getElementById('restartBtn');
      var form = document.getElementById('restartForm');
      if (btn && form) {
        btn.addEventListener('click', async function(){
          const ok = await window.showConfirmModal({
            title: 'Start New Game',
            message: 'This will clear the current game and return to setup. Continue?',
            okText: 'Start New Game',
            cancelText: 'Cancel'
          });
          if (ok) form.submit();
        });
      }
    })();
  </script>
</body>
</html>
