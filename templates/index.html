<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================================
       PAGE META / PWA BASICS
       ========================================================= -->
  <meta charset="UTF-8">
  <!-- Prevent auto zoom on mobile + enable iOS safe areas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Darts Golf Scorer</title>

  <!-- Manifest + theme-color for PWA -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
  <meta name="theme-color" content="#182634">

  <!-- iOS/Android standalone capability -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Darts Golf">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Service Worker registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js').catch(()=>{}));
    }
  </script>

  <!-- Favicons / Touch icons -->
  <link rel="icon" href="{{ url_for('static', filename='icons/dartboard.svg') }}" type="image/svg+xml">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/dartboard-32.png') }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/dartboard-192.png') }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/dartboard-180.png') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

  <!-- =========================================================
       GLOBAL STYLES (CSS)
       ========================================================= -->
  <style>
    /* ------------------------------
       CSS Variables / Color System
       ------------------------------ */
    :root {
      --bg-color:#1a1a1a;
      --text-color:#f0f0f0;
      --border-color:#444;

      --primary-color:#E3292E;   /* RED (current turn & stats) */
      --secondary-color:#309F6A; /* GREEN (negative deltas) */

      --accent-color:#F9DFBC;    /* SCORE CELL BACKGROUND */
      --accent-text-color:#000;  /* Running total text in cells */

      /* Live-tuned by JS to ensure content isn't hidden under controls */
      --controls-h: 96px;             /* fallback */
      --controls-extra-bottom: 0px;   /* kept for compatibility; forced to 0 via JS */
    }

    /* ------------------------------
       iOS-SAFE PAGE SCROLL LOCK
       Body never scrolls; only .container scrolls
       ------------------------------ */
    html, body { height: 100%; }
    html { overflow: hidden; }            /* never allow page scroll */

    body{
      margin:0; /* ensure no default margin creates gaps */
      position: fixed;
      inset: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background:var(--bg-color);
      color:var(--text-color);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;

      /* Keep top/side safe areas, but REMOVE bottom padding.
         The controls & container already handle bottom insets. */
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: 0; /* ‚Üê was env(safe-area-inset-bottom) */
      padding-left: env(safe-area-inset-left);
    }


    /* ------------------------------
       Main scroll area
       ------------------------------ */
    .container{
      flex:1;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;   /* momentum on iOS */
      overscroll-behavior:contain;        /* stop bounce from bubbling */
      padding:15px 2px;
      /* Keep last rows clear of the bottom controls + iOS safe area */
      padding-bottom: calc(15px + var(--controls-h));
      -ms-overflow-style:none; scrollbar-width:none;
    }
    .container::-webkit-scrollbar{ display:none; }

    /* ------------------------------
       Controls (Bottom Bar) ‚Äî fixed & flush to bottom
       ------------------------------ */
.controls{
  /*position: fixed;*/
  left: 0;
  right: 0;
  bottom: 0;
  background:#000;
  border-top:2px solid var(--border-color);
  z-index: 19;

  /* Fix A: regular visual padding only (no safe-area here) */
  padding: 10px 10px calc(0px + env(safe-area-inset-bottom));
}

/* Extend the bar‚Äôs background into the home-indicator area
   without moving the buttons */
.controls::after{
  content:"";
  display:block;
  height: env(safe-area-inset-bottom);
}


    .button-grid{
      display:grid; grid-template-columns:repeat(6,1fr);
      gap:10px; margin-bottom:10px;
    }
    .button-grid.single{ grid-template-columns:1fr; }
    .button-grid.two{ grid-template-columns:repeat(2,1fr); }

    .utility-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    .button-grid button,
    .utility-grid button{
      width:100%; padding:20px 0; font-size:1.8em; font-weight:bold;
      border:none; border-radius:8px; cursor:pointer; touch-action:manipulation; white-space:nowrap;
    }

    /* Score buttons */
    .score-btn.minus{ background:var(--secondary-color); color:#fff; }
    .score-btn.plus{  background:var(--primary-color);  color:#fff; }
    .score-btn.zero{  background:#616161; color:#fff; }

    /* Utility buttons */
    .undo-btn{ background:#ff9800; color:#000; }
    .restart-btn{ background:#f44336; color:#fff; }
    .export-btn{ background:#2196f3; color:#fff; }
    .end-btn{ background:#2196f3; color:#fff; }
    .settings-btn{
      background:#555; color:#fff;
      font-size:1.1em; padding:12px 16px; border-radius:8px; border:none; cursor:pointer;
    }

    /* ------------------------------
       Forms / Input ergonomics
       ------------------------------ */
    .settings-input,
    .settings-text,
    #nameField { font-size:18px; }

    /* ------------------------------
       Setup Screen
       ------------------------------ */
    .setup-screen{
      text-align:center;
      padding-top:4vh;
      max-width:950px; margin:0 auto;
      padding-left:8px; padding-right:8px;
    }
    .setup-actions{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:8px; }
    .setup-screen button{
      padding:15px 30px; font-size:1.1em;
      background:var(--secondary-color); color:#fff; border:none; border-radius:8px; cursor:pointer;
    }

    .flash{
      margin:0 auto 16px; padding:12px 16px; border-radius:8px;
      border:1px solid #ff4d4d; background:#2a0000; color:#ffcccc; font-weight:600;
    }

    .recent-wrap{ margin-top:14px; }
    .recent-title{ color:#ccc; font-size:.95em; margin-bottom:8px; }
    .chip-list{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }

    /* Player "chips" ‚Äî WHITE text by default */
    .chip{
      background:#2b2b2b; color:#fff;
      border:1px solid #444; padding:8px 12px; border-radius:16px; cursor:grab;
      user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
      font-size:.95em; touch-action:none;
      display:inline-flex; align-items:center; gap:8px;
      box-sizing:border-box;
    }
    .chip.selected{ background:var(--secondary-color); border-color:var(--secondary-color); }
    .chip.draggable{ cursor:grab; }
    .chip.dragging{ opacity:.85; }
    .chip.placeholder{ border:2px dashed #666; background:transparent; }

    /* Number badge on selected chips */
    .chip .chip-index{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:1.4em; height:1.4em;
      padding:0 .25em; margin-right:2px;
      border-radius:999px; background:#444; color:#fff;
      font-weight:900; font-size:.85em; line-height:1;
    }

    /* ‚úï remove button inside the chip */
    .chip .chip-remove{
      margin-left:2px;
      background:transparent; border:none; color:#fff;
      font-weight:900; font-size:1em; line-height:1;
      cursor:pointer; padding:0 .3em; border-radius:6px;
    }
    .chip .chip-remove:focus-visible{ outline:2px solid #888; }

    .name-input-wrap input.settings-input{
      background:#101010; border:1px solid var(--border-color);
      border-radius:8px; color:#fff;
    }
    .name-input-wrap #addNameBtn{
      background:#309F6A; color:#fff; border:none; border-radius:8px; font-weight:800;
    }

    /* ------------------------------
       Scoreboard Table (all phases)
       ------------------------------ */
    .scoreboard{
      width:100%; border-collapse:collapse; table-layout:fixed;
      margin-bottom:20px;
    }
    .scoreboard th,.scoreboard td{
      border:1px solid var(--border-color); text-align:center; word-wrap:break-word;
    }
    .scoreboard thead th{
      font-size:1.2em; padding:8px 5px; line-height:1.4; vertical-align:middle; background:#333;
    }
    .scoreboard tbody th,.scoreboard tbody td{ font-size:1.5em; vertical-align:middle; }
    .scoreboard tbody th{ background:#2b2b2b; font-size:1.1em; padding:12px 5px; }
    .scoreboard tbody td{
      background:var(--accent-color); color:var(--accent-text-color);
      font-weight:bold; padding:12px 5px;
    }
    .scoreboard .total-row td{ background:#333; color:#fff; }

    /* Player name colors:
       - Default headers: WHITE
       - Current player's header: RED
       - Stats page names: RED via .stat-player */
    .scoreboard thead th:not(:first-child){ color:#fff; }
    .scoreboard.final thead tr:nth-child(2) th:not(:first-child){ color:#fff; }
    .current-player-header{ color:var(--primary-color); font-weight:bold; }

    /* ------------------------------
       Info Bar
       ------------------------------ */
    .info-bar{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:6px; margin-bottom:15px;
    }
    .round-count{ display:flex; align-items:flex-end; justify-content:center; gap:8px; line-height:1; margin-top:4px; flex-wrap:nowrap; }
    .round-label{ font-size:clamp(28px, 7vw, 56px); font-weight:900; letter-spacing:.06em; }
    .round-number{ font-size:clamp(44px, 12vw, 96px); font-weight:900; line-height:.9; color:#bbb; }
    .round-total{ font-size:clamp(10px, 2.8vw, 16px); font-weight:700; opacity:.85; margin-left:2px; align-self:flex-start; transform:translateY(-6px); }
    .turn-info{ font-size:clamp(18px, 4.2vw, 28px); font-weight:700; color:var(--primary-color); text-align:center; }

    .end-banner-wrap{ background:#182634; border-radius:12px; padding:10px; margin-top:12px; }
    .end-banner{
      margin:0; padding:12px 16px; border:1px dashed #2196f3; color:#fff; background:transparent; border-radius:8px;
      font-weight:700; text-align:center;
    }

    .scoreboard tr.current-row th{ background:#3a3a3a; }

    /* Cell internals (running total + delta chip) */
    .cell{ position:relative; display:flex; align-items:center; justify-content:center; min-height:58px; width:100%; height:100%; }
    .total-pill{ color:#000; background:none; padding:0; border-radius:0; font-weight:900; font-size:1.2em; line-height:1; }

    .delta-corner{
      position:absolute; right:0; bottom:0; width:32px; height:32px; border-top-left-radius:100%;
      background:#000; color:#fff; display:flex; align-items:flex-end; justify-content:flex-end; font-weight:900; font-size:.75em;
      pointer-events:none; padding:2px 5px; box-sizing:border-box; overflow:hidden; line-height:1;
    }
    .delta-corner.pos{  background:var(--primary-color); }
    .delta-corner.neg{  background:var(--secondary-color); }
    .delta-corner.zero{ background:#000; }
    .delta-corner.hidden{ opacity:0; }

    .scoreboard.playing tbody td,
    .scoreboard.final tbody td{ padding:0; }
    .scoreboard.playing td .cell,
    .scoreboard.final   td .cell{ width:100%; height:100%; }

    /* Hero images */
    .homepage-dartboard,
    .final-standings-img{
      display:block; width:auto; height:auto; max-width:min(92vw, 520px); max-height:48vh;
      margin:0 auto 20px; object-fit:contain;
    }

    /* ------------------------------
       UI Effects (score bubble)
       ------------------------------ */
    .score-bubble{
      position:fixed; z-index:9999; padding:6px 10px; border-radius:999px;
      font-weight:800; font-size:.95em; white-space:nowrap; pointer-events:none;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
      transform:translate(-50%,0) scale(.95); opacity:0;
      animation:floatUp 900ms ease-out forwards;
      will-change:transform,opacity;
    }
    .score-bubble.pos{  background:var(--primary-color); color:#fff; }
    .score-bubble.neg{  background:var(--secondary-color); color:#fff; }
    .score-bubble.zero{ background:#000; color:#fff; }

    @keyframes floatUp{
      0%{   transform:translate(-50%,8px)  scale(.95); opacity:0; }
      15%{  transform:translate(-50%,0px) scale(1);   opacity:1; }
      100%{ transform:translate(-50%,-64px) scale(1.05); opacity:0; }
    }

    /* Winner banner (final page) */
    .winner-banner{
      color:var(--primary-color); font-weight:900; text-align:center;
      font-size:clamp(32px, 8.5vw, 64px);
      margin:8px auto 14px; letter-spacing:.02em;
    }

    #final-capture{ overflow:visible; }

    /* ------------------------------
       Modals (Confirm / Settings / iOS Install hint)
       ------------------------------ */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; z-index:10000; padding:20px;
    }
    .modal{
      background:#111; border:1px solid var(--border-color); border-radius:12px;
      max-width:560px; width:100%; padding:18px; box-shadow:0 12px 36px rgba(0,0,0,.6);
    }
    .modal h3{ margin:0 0 8px; font-size:1.3em; }
    .modal p{ margin:0 0 16px; color:#ddd; }
    .modal-actions{ display:flex; gap:10px; justify-content:flex-end; }
    .modal-actions .btn{
      padding:10px 16px; font-size:1.05em; font-weight:800; border:none; border-radius:8px; cursor:pointer;
    }
    .btn-cancel{ background:#444; color:#fff; }
    .btn-confirm{ background:#2196f3; color:#fff; }

    /* Settings modal (rows) */
    .settings-grid{ display:grid; gap:10px; }
    .settings-row{ display:grid; gap:6px; }
    .settings-help{ color:#bbb; font-size:.9em; }

    /* ------------------------------
      Playing-page utility row (now using button-grid two)
      ------------------------------ */
    .button-grid.two.playing{ grid-template-columns:1fr 1fr; }
    .button-grid.two.playing button{
      white-space:nowrap; font-size:clamp(16px, 4.5vw, 28px); padding:clamp(12px, 3.5vw, 20px) 0;
    }

    /* ------------------------------
      Toasts
      ------------------------------ */
    .toast-container{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      z-index:10050; display:flex; flex-direction:column; gap:8px; pointer-events:none;
    }
    .toast{
      pointer-events:auto; background:#222; color:#fff; border:1px solid var(--border-color);
      border-radius:10px; padding:10px 14px; font-weight:800; font-size:.95em;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      opacity:0; transform:translateY(6px);
      transition:opacity .18s ease, transform .18s ease;
      display:flex; align-items:center; gap:10px;
    }
    .toast.show{ opacity:1; transform:translateY(0); }
    .toast--error{ background:#3b1111; border-color:#6b1d1d; }
    .toast--success{ background:#113b25; border-color:#1d6b3a; }
    .toast--info{ background:#11233b; border-color:#1d3b6b; }
    .toast button{ background:#2196f3; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:800; }

    /* ------------------------------
       Reduced Motion
       ------------------------------ */
    @media (prefers-reduced-motion: reduce){
      .score-bubble{ animation:none !important; opacity:1; }
    }

    /* Confetti canvas (winner) */
    #confettiCanvas{ position:fixed; inset:0; pointer-events:none; z-index:9998; }

    /* ------------------------------
       STATS PAGE STYLES (names red)
       ------------------------------ */
    .stat-block{
      background:#111; border:1px solid var(--border-color); border-radius:12px;
      padding:14px 16px; margin:12px auto; max-width:900px;
    }
    .stat-title{
      font-weight:900; font-size:1.2em; color:#e5e5e5;
      margin:0 0 10px; letter-spacing:.02em;
    }
    .stat-value{ font-size:1.3em; font-weight:900; color:#fff; }
    .stat-player{
      font-weight:800; color:var(--primary-color); /* red on stats */
      display:inline-block;
    }
    .stat-block ol{ margin:0; padding-left:1.1em; list-style:decimal; }
    .stat-block ol li{
      display:flex; justify-content:space-between; align-items:flex-start;
      padding:8px 0; border-bottom:1px dashed #333;
      gap:12px;
    }
    .stat-block ol li:last-child{ border-bottom:none; }

    /* Helpers for ‚Äúfrom‚Ä¶to‚Ä¶‚Äù under name */
    .stat-left{ display:flex; flex-direction:column; gap:2px; min-width:170px; }
    .stat-sub{ color:#ccc; opacity:0.95; margin-left:0; }
    .stat-right{ font-weight:900; white-space:nowrap; color:#fff; }

    /* ------------------------------
       Scroll-control utility class hooks (optional)
       ------------------------------ */
    .no-overscroll{ overscroll-behavior: contain; }
  </style>
</head>

<body>
  <!-- =========================================================
       GLOBAL CANVAS FOR CONFETTI
       ========================================================= -->
  <canvas id="confettiCanvas"></canvas>

  <!-- =========================================================
       MAIN CONTENT CONTAINER
       ========================================================= -->
  <div class="container">

    {% if show_stats %}
      <!-- =====================================================
           STATS VIEW
           ===================================================== -->
      <h1>Game Stats</h1>

      <div class="stat-block">
        <div class="stat-title">‚õ≥ Birdie Streaks</div>
        {% if birdie_streak_ranking %}
          <ol>
            {% for row in birdie_streak_ranking %}
              <li>
                <div class="stat-left">
                  <span class="stat-player">{{ row.name }}</span>
                </div>
                <div class="stat-right">{{ row.streak }}</div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">‚Äî</div>
          <small>No completed rounds yet.</small>
        {% endif %}
      </div>

      <div class="stat-block">
        <div class="stat-title">üî• Bogey Streaks</div>
        {% if bogey_streak_ranking %}
          <ol>
            {% for row in bogey_streak_ranking %}
              <li>
                <div class="stat-left">
                  <span class="stat-player">{{ row.name }}</span>
                </div>
                <div class="stat-right">{{ row.streak }}</div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">‚Äî</div>
          <small>No completed rounds yet.</small>
        {% endif %}
      </div>

      <div class="stat-block">
        <div class="stat-title">üïäÔ∏è Total Birdies</div>
        {% if most_birdies_ranking %}
          <ol>
            {% for row in most_birdies_ranking %}
              <li>
                <div class="stat-left">
                  <span class="stat-player">{{ row.name }}</span>
                </div>
                <div class="stat-right">{{ row.count }}</div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">‚Äî</div>
          <small>No completed rounds yet.</small>
        {% endif %}
      </div>
      
      <div class="stat-block">
        <div class="stat-title">üìä Average Scores</div>
        {% if average_ranking %}
          <ol>
            {% for row in average_ranking %}
              <li>
                <div class="stat-left">
                  <span class="stat-player">{{ row.name }}</span>
                  <small class="stat-sub">(over {{ row.rounds }} rounds)</small>
                </div>
                <div class="stat-right">{{ "%+.2f"|format(row.average) }}</div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">‚Äî</div>
          <small>No completed rounds yet.</small>
        {% endif %}
      </div>

      <div class="stat-block">
        <div class="stat-title">‚Ü©Ô∏è Biggest Comebacks</div>
        {% if comeback_ranking %}
          <ol>
            {% for cb in comeback_ranking %}
              <li>
                <div class="stat-left">
                  <span class="stat-player">{{ cb.player }}</span>
                  <small class="stat-sub">
                    from {{ "%+d"|format(cb.from_score) }} on Round {{ cb.from_round }}
                    to {{ "%+d"|format(cb.to_score) }} on Round {{ cb.to_round }}
                  </small>
                </div>
                <div class="stat-right">{{ cb.improvement }} saved</div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="stat-value">‚Äî</div>
          <small>No positive improvements detected.</small>
        {% endif %}
      </div>

    {% else %}
      <!-- =====================================================
           NORMAL GAME VIEWS
           ===================================================== -->

      {% if game.phase == 'setup' %}
        <!-- =========================
             SETUP PHASE
             ========================= -->
        <div class="setup-screen">
          <img src="{{ url_for('static', filename='images/dartsgolf4.png') }}" alt="Darts Golf Scorer Dartboard" class="homepage-dartboard">

          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, msg in messages %}
                <div class="flash">{{ msg }}</div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <!-- Add-one-name-at-a-time input -->
          <form id="startForm" action="{{ url_for('start_game') }}" method="post" style="margin-top:12px;">
            <input id="playersInput" type="hidden" name="players" required>

            <div class="name-input-wrap" style="position:relative; display:flex; gap:8px; align-items:center; margin-top:8px;">
              <input
                id="nameField"
                type="text"
                placeholder="Type a player name"
                aria-label="Player name"
                class="settings-input"
                style="flex:1; padding-right:56px;"
                autocomplete="off"
                inputmode="text"
              >
              <button
                type="button"
                id="addNameBtn"
                class="settings-btn"
                aria-label="Add player"
                title="Add player"
                style="position:absolute; right:6px; top:50%; transform:translateY(-50%); padding:8px 12px;"
              >‚ûú</button>
            </div>
            <small style="display:block; color:#bbb; margin-top:6px;">
              Press <b>Enter</b> or tap the arrow to add. Tap <b>‚úï</b> to remove. Drag pills to reorder.
            </small>

            <!-- Selected players (chips you build) -->
            <div class="selected-wrap" id="selectedWrap" style="margin-top:12px; display:none;">
              <div class="selected-title">Players (drag to reorder)</div>
              <div id="selectedChipList" class="chip-list"></div>
            </div>
          </form>

          {% if game.recent_names %}
            <div class="recent-wrap">
              <div class="recent-title">Recent players</div>
              <div id="chipList" class="chip-list"></div>
            </div>
          {% endif %}
        </div>

      {% elif game.phase == 'playing' %}
        <!-- =========================
             PLAYING PHASE
             ========================= -->
        <div class="info-bar" id="info-bar" aria-live="polite" role="status">
          <div class="round-count">
            <span class="round-label">ROUND</span>
            <span class="round-number">{{ "%02d"|format(game.current_round) }}</span>
            <span class="round-total">/ 20</span>
          </div>
          <div class="turn-info">{{ game.players[game.current_player_index] }}'s Turn</div>

          {% if game.end_after_round %}
            <div class="end-banner-wrap">
              <div class="end-banner">
                Game will end after this round. Finish all players this round to finalize and run tie-breakers.
              </div>
            </div>
          {% endif %}
        </div>

        <table class="scoreboard playing" id="scoreboard">
          <thead>
            <tr><th>&nbsp;</th>
              {% for p in game.players %}
                <th class="{{ 'current-player-header' if p == game.players[game.current_player_index] else '' }}">{{ p }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr class="total-row"><th>Total</th>
              {% for p in game.players %}
                {% set s = game.scores.get(p,0) %}
                <td>{% if s>0 %}+{% endif %}{{ s }}</td>
              {% endfor %}
            </tr>

            <tr class="current-row"><th>{{ "%02d"|format(game.current_round) }}</th>
              {% for p in game.players %}
                {% set v = game.round_history[game.current_round - 1].get(p) %}
                {% if v is not none %}
                  {% set ns = namespace(total=0) %}
                  {% for r in range(game.current_round) %}
                    {% set ns.total = ns.total + (game.round_history[r].get(p, 0)) %}
                  {% endfor %}
                  <td>
                    <div class="cell">
                      <span class="total-pill">{{ ns.total>0 and '+' or '' }}{{ ns.total }}</span>
                      <span class="delta-corner {{ 'pos' if v>0 else ('neg' if v<0 else 'zero') }}">
                        {{ v>0 and '+' or '' }}{{ v }}
                      </span>
                    </div>
                  </td>
                {% else %}
                  <td>
                    <div class="cell">
                      <span class="total-pill">0</span>
                      <span class="delta-corner hidden">0</span>
                    </div>
                  </td>
                {% endif %}
              {% endfor %}
            </tr>

            {% for i in range(game.current_round - 1) | reverse %}
              <tr><th>{{ "%02d"|format(i + 1) }}</th>
                {% for p in game.players %}
                  {% set v = game.round_history[i].get(p) %}
                  {% if v is not none %}
                    {% set ns = namespace(total=0) %}
                    {% for r in range(i + 1) %}
                      {% set ns.total = ns.total + (game.round_history[r].get(p, 0)) %}
                    {% endfor %}
                    <td>
                      <div class="cell">
                        <span class="total-pill">{{ ns.total>0 and '+' or '' }}{{ ns.total }}</span>
                        <span class="delta-corner {{ 'pos' if v>0 else ('neg' if v<0 else 'zero') }}">
                          {{ v>0 and '+' or '' }}{{ v }}
                        </span>
                      </div>
                    </td>
                  {% else %}
                    <td></td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>

      {% elif game.phase == 'playoff' %}
        <!-- =========================
             PLAYOFF (TIE-BREAKER) PHASE
             ========================= -->
        <div class="info-bar" id="info-bar" aria-live="polite" role="status">
          <div class="round-count">
            <span class="round-label">TIE-BREAKER</span>
            <span class="round-number">{{ "%02d"|format(game.playoff_round) }}</span>
          </div>
          <div class="turn-info">{{ game.playoff_group[game.current_player_index] }}'s Turn</div>
        </div>
        <table class="scoreboard" id="scoreboard">
          <thead>
            <tr><th>&nbsp;</th>
              {% for p in game.playoff_group %}
                <th class="{{ 'current-player-header' if p == game.playoff_group[game.current_player_index] else '' }}">{{ p }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr class="total-row"><th>Total</th>
              {% for _ in game.playoff_group %}
                {% set s = game.playoff_base_score %}
                <td>{% if s>0 %}+{% endif %}{{ s }}</td>
              {% endfor %}
            </tr>

            {% set total_tb = game.playoff_history|length %}
            {% for round_scores in game.playoff_history | reverse %}
              {% set tb_num = total_tb - loop.index0 %}
              <tr><th>TB {{ "%02d"|format(tb_num) }}</th>
                {% for p in game.playoff_group %}
                  {% set v = round_scores.get(p) %}
                  {% if v is not none %}
                    <td>{% if v>0 %}+{% endif %}{{ v }}</td>
                  {% else %}
                    <td></td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>

      {% elif game.phase == 'final_ranking' %}
        <!-- =========================
             FINAL RANKING PHASE
             ========================= -->
        <div id="final-capture">
          <div class="status-box">
            <img src="{{ url_for('static', filename='images/finalstanding1.png') }}" alt="Final Standings" class="final-standings-img">
          </div>

          {% set winner_name = game.winner or (game.final_standings and game.final_standings[0].name) %}
          {% if winner_name %}
            <div class="winner-banner" role="status" aria-live="polite">
              üèÜ Winner: {{ winner_name }}
            </div>
          {% endif %}

          <table class="scoreboard final" id="scoreboard">
            <thead>
              <tr><th>&nbsp;</th>
                {% for st in game.final_standings %}
                  <th>{% set r=st.rank %}{% set sfx='th' %}
                      {% if r % 10 == 1 and r % 100 != 11 %}{% set sfx='st' %}{% endif %}
                      {% if r % 10 == 2 and r % 100 != 12 %}{% set sfx='nd' %}{% endif %}
                      {% if r % 10 == 3 and r % 100 != 13 %}{% set sfx='rd' %}{% endif %}
                      {{ r }}{{ sfx }}</th>
                {% endfor %}
              </tr>
              <tr><th>Player</th>
                {% for st in game.final_standings %}<th>{{ st.name }}</th>{% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr class="total-row"><th>Final</th>
                {% for st in game.final_standings %}
                  {% set s = st.score %}
                  <td>{% if s>0 %}+{% endif %}{{ s }}</td>
                {% endfor %}
              </tr>

              {% for i in range(game.max_playoff_rounds, 0, -1) %}
                <tr><th>TB {{ "%02d"|format(i) }}</th>
                  {% for st in game.final_standings %}
                    {% set hist = game.all_playoff_history.get(st.name, []) %}
                    {% if i <= hist|length %}
                      {% set v = hist[i-1] %}
                      <td>{% if v>0 %}+{% endif %}{{ v }}</td>
                    {% else %}
                      <td>-</td>
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}

              {% set rp = game.rounds_played or 0 %}
              {% for i in range(rp - 1, -1, -1) %}
                <tr><th>{{ "%02d"|format(i + 1) }}</th>
                  {% for st in game.final_standings %}
                    {% set v = game.round_history[i].get(st.name) %}
                    {% if v is not none %}
                      {% set ns = namespace(total=0) %}
                      {% for r in range(i + 1) %}
                        {% set ns.total = ns.total + (game.round_history[r].get(st.name, 0)) %}
                      {% endfor %}
                      <td>
                        <div class="cell">
                          <span class="total-pill">{{ ns.total>0 and '+' or '' }}{{ ns.total }}</span>
                          <span class="delta-corner {{ 'pos' if v>0 else ('neg' if v<0 else 'zero') }}">
                            {{ v>0 and '+' or '' }}{{ v }}
                          </span>
                        </div>
                      </td>
                    {% else %}
                      <td></td>
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- =========================================================
       MODALS
       ========================================================= -->
  <div id="confirmOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" aria-describedby="confirmMessage">
      <h3 id="confirmTitle">Confirm</h3>
      <p id="confirmMessage">Are you sure?</p>
      <div class="modal-actions">
        <button type="button" class="btn btn-cancel" id="confirmCancelBtn">Cancel</button>
        <button type="button" class="btn btn-confirm" id="confirmOkBtn">OK</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal (with Add to Home Screen button) -->
  <div id="settingsOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <h3 id="settingsTitle">Settings</h3>
      <div class="settings-grid">
        <div class="settings-row">
          <label style="display:flex; align-items:center; gap:10px; font-weight:700;">
            <input id="hapticsToggle" type="checkbox">
            Haptic feedback
          </label>
          <div class="settings-help">Android: vibration ¬∑ iOS: subtle tap sound</div>
        </div>

        <!-- Add to Home Screen button (shown when eligible) -->
        <div class="settings-row">
          <button type="button" id="installBtnSettings" class="btn btn-confirm" style="display:none;">
            ‚ûï Add to Home Screen
          </button>
          <div class="settings-help">Install this app as a shortcut on your device.</div>
        </div>
      </div>
      <div class="modal-actions" style="margin-top:12px;">
        <button type="button" class="btn btn-cancel" onclick="closeSettings()">Close</button>
        <button type="button" class="btn btn-confirm" onclick="saveSettings()">Save</button>
      </div>
      <div class="settings-help" style="margin-top:8px;">
        Current: <b id="settingsSummary"></b>
      </div>
    </div>
  </div>

  <!-- iOS Add-to-Home instructions -->
  <div id="iosInstallOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="iosInstallTitle">
      <h3 id="iosInstallTitle">Add to Home Screen</h3>
      <p style="margin-top:6px;">
        On iPhone/iPad (Safari): tap the <b>Share</b> button, then choose <b>Add to Home Screen</b>.
      </p>
      <div class="modal-actions" style="margin-top:12px;%;">
        <button type="button" class="btn btn-confirm" onclick="closeIosInstall()">OK</button>
      </div>
    </div>
  </div>

  <!-- Toast host -->
  <div id="toastHost" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- =========================================================
       SCRIPT: INITIAL SERVER STATE INJECTION
       ========================================================= -->
  <script>
    window.__gameCache = {{ game | tojson | safe }};
  </script>

  <!-- =========================================================
       SCRIPT: CONFIRM HELPER
       ========================================================= -->
  <script>
    (function(){
      const overlay = document.getElementById('confirmOverlay');
      const titleEl = document.getElementById('confirmTitle');
      const msgEl   = document.getElementById('confirmMessage');
      const okBtn   = document.getElementById('confirmOkBtn');
      const cancelBtn = document.getElementById('confirmCancelBtn');
      let resolver = null;

      function openModal(opts){
        const { title='Confirm', message='Are you sure?', okText='OK', cancelText='Cancel' } = opts || {};
        titleEl.textContent = title;
        msgEl.textContent   = message;
        okBtn.textContent   = okText;
        cancelBtn.textContent = cancelText;
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        setTimeout(()=> okBtn.focus(), 0);
        return new Promise(resolve => { resolver = resolve; });
      }
      function closeModal(result){
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
        if (resolver){ const r = resolver; resolver = null; r(result); }
      }
      okBtn.addEventListener('click', ()=> closeModal(true));
      cancelBtn.addEventListener('click', ()=> closeModal(false));
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(false); });
      window.addEventListener('keydown', (e)=>{ if (overlay.style.display === 'flex' && e.key === 'Escape') closeModal(false); });
      window.showConfirmModal = openModal;
    })();
  </script>

  <!-- =========================================================
       SCRIPT: TOAST HELPERS
       ========================================================= -->
  <script>
    function showToast(message, type='info', ms=2200){
      const host = document.getElementById('toastHost');
      if(!host) return ()=>{};
      const t = document.createElement('div');
      t.className = 'toast toast--' + type;
      t.textContent = message;
      host.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show'));
      const remove = ()=> { t.classList.remove('show'); setTimeout(()=> t.remove(), 200); };
      setTimeout(remove, ms);
      return remove;
    }
    function showActionToast(message, actionText, onClick, type='info', ms=6000){
      const host = document.getElementById('toastHost');
      if(!host) return ()=>{};
      const t = document.createElement('div');
      t.className = 'toast toast--' + type;
      const span = document.createElement('span');
      span.textContent = message;
      const btn = document.createElement('button');
      btn.textContent = actionText;
      btn.addEventListener('click', ()=>{ try{ onClick(); }catch(e){} remove(); });
      t.appendChild(span); t.appendChild(btn);
      host.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show'));
      const remove = ()=> { t.classList.remove('show'); setTimeout(()=> t.remove(), 200); };
      setTimeout(remove, ms);
      return remove;
    }
  </script>

  <!-- =========================================================
       SCRIPT: HAPTIC FEEDBACK
       ========================================================= -->
  <script>
  (function(){
    const HAPTIC_KEY = 'darts-haptics-enabled';
    function isHapticsOn(){ const v = localStorage.getItem(HAPTIC_KEY); return v === null ? true : v === '1'; }
    function setHaptics(on){ localStorage.setItem(HAPTIC_KEY, on ? '1' : '0'); }
    window.hapticsPref = { isOn: isHapticsOn, set: setHaptics };

    let audioCtx;
    function ensureAudio(){
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = AC ? new AC() : null;
      }
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }
    function softClick(ms=70, freq=70){
      const ctx = ensureAudio(); if (!ctx) return;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'square';
      osc.frequency.value = freq;
      const t0 = ctx.currentTime;
      gain.gain.setValueAtTime(0, t0);
      gain.gain.linearRampToValueAtTime(0.16, t0 + 0.006);
      gain.gain.exponentialRampToValueAtTime(0.001, t0 + ms/1000);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t0); osc.stop(t0 + ms/1000 + 0.03);
    }
    function doubleClick(){ softClick(60, 85); setTimeout(()=> softClick(70, 60), 70); }

    const PATTERNS = { light:30, medium:[24,40,24], success:[20,40,20,50,70] };
    function tryVibrate(kind){
      if (!('vibrate' in navigator)) return false;
      const pattern = kind==='medium' ? PATTERNS.medium : (kind==='success' ? PATTERNS.success : PATTERNS.light);
      try{ return !!navigator.vibrate(pattern); }catch{ return false; }
    }

    window.haptic = function(kind='light'){
      if (!isHapticsOn()) return;
      const ok = tryVibrate(kind);
      if (ok) return;
      if (kind==='light') softClick(70, 70);
      else if (kind==='medium') doubleClick();
      else if (kind==='success'){ softClick(60, 90); setTimeout(()=> softClick(80, 50), 90); }
      else softClick(70, 70);
    };
    ['touchstart','mousedown','keydown'].forEach(ev=>{
      window.addEventListener(ev, ()=>{ ensureAudio(); }, { once:true, passive:true });
    });
    window.testHaptics = function(){
      const ok = tryVibrate('medium');
      if (!ok) doubleClick();
    };
  })();
  </script>

  <!-- =========================================================
       SCRIPT: PWA INSTALL (button lives in Settings)
       ========================================================= -->
  <script>
    (function(){
      const installBtn  = document.getElementById('installBtnSettings');
      const iosOverlay  = document.getElementById('iosInstallOverlay');
      let deferredPrompt = null;

      function isStandalone(){
        return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      }
      function isIOS(){ return /iPhone|iPad|iPod/i.test(navigator.userAgent); }
      function isSafari(){ return isIOS() && /Safari/i.test(navigator.userAgent) && !/CriOS|FxiOS|EdgiOS/i.test(navigator.userAgent); }

      function showInstallBtn(){ if (installBtn) installBtn.style.display = 'inline-block'; }
      function hideInstallBtn(){ if (installBtn) installBtn.style.display = 'none'; }

      function openIosInstall(){
        if (!iosOverlay) return;
        iosOverlay.style.display = 'flex';
        iosOverlay.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }
      window.closeIosInstall = function(){
        if (!iosOverlay) return;
        iosOverlay.style.display = 'none';
        iosOverlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      };

      window.updateInstallVisibility = function(){
        if (isStandalone()){ hideInstallBtn(); return; }
        if (deferredPrompt || isSafari()) showInstallBtn();
        else hideInstallBtn();
      };

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        window.updateInstallVisibility();
      });

      window.addEventListener('appinstalled', () => {
        hideInstallBtn();
        showToast('App installed! üéâ', 'success');
        deferredPrompt = null;
      });

      installBtn?.addEventListener('click', async () => {
        if (isStandalone()) { showToast('Already installed', 'info'); hideInstallBtn(); return; }
        if (deferredPrompt) {
          deferredPrompt.prompt();
          try {
            const choice = await deferredPrompt.userChoice;
            if (choice && choice.outcome === 'accepted') {
              showToast('Installing‚Ä¶', 'info');
            }
          } finally {
            deferredPrompt = null;
            setTimeout(window.updateInstallVisibility, 0);
          }
        } else if (isSafari()) {
          openIosInstall();
        } else {
          showToast('Install not supported in this browser', 'info');
        }
      });

      document.addEventListener('DOMContentLoaded', window.updateInstallVisibility);
    })();
  </script>

  {% if game.phase == 'setup' and not show_stats %}
  <!-- =========================================================
       SCRIPT: SETUP PAGE ‚Äî Pills with Pointer Events drag
       ========================================================= -->
  <script>
    // ---------- State ----------
    const recentNames      = {{ (game.recent_names or []) | tojson | safe }};
    const chipList         = document.getElementById('chipList');           // recent chips (if any)
    const selectedWrap     = document.getElementById('selectedWrap');       // container for selected chips
    const selectedChipList = document.getElementById('selectedChipList');
    const playersHidden    = document.getElementById('playersInput');       // hidden CSV posted to /start
    const nameField        = document.getElementById('nameField');
    const addNameBtn       = document.getElementById('addNameBtn');
    const startForm        = document.getElementById('startForm');

    let selected = []; // array of names in order (case-preserving)

    function norm(s){ return (s||'').trim().replace(/\s+/g,' '); }
    function idxOfName(arr, name){
      const n = name.toLowerCase();
      for (let i=0;i<arr.length;i++) if (arr[i].toLowerCase()===n) return i;
      return -1;
    }

    // ---------- Rendering ----------
    function renderSelected(){
      selectedWrap.style.display = selected.length ? 'block' : 'none';
      selectedChipList.innerHTML = selected.map((n, i) => (
        `<div class="chip draggable" data-name="${escapeHtml(n)}" title="Drag to reorder">
           <span class="chip-index">${i+1}</span>
           <span class="chip-name">${escapeHtml(n)}</span>
           <button type="button" class="chip-remove" aria-label="Remove ${escapeHtml(n)}" title="Remove">‚úï</button>
         </div>`
      )).join('');
      bindSelectedEvents();
      writeHidden();
      reflectRecentSelection();
    }

    function renderRecent(){
      if (!chipList) return;
      chipList.innerHTML = recentNames.map(n =>
        `<div class="chip" data-name="${escapeHtml(n)}">${escapeHtml(n)}</div>`
      ).join('');
      chipList.querySelectorAll('.chip').forEach(el=>{
        el.addEventListener('click', ()=>{
          const name = el.getAttribute('data-name');
          toggleName(name);
        });
      });
      reflectRecentSelection();
    }

    function reflectRecentSelection(){
      if (!chipList) return;
      chipList.querySelectorAll('.chip').forEach(el=>{
        const n = el.getAttribute('data-name');
        const sel = idxOfName(selected, n) >= 0;
        el.classList.toggle('selected', sel);
      });
    }

    function writeHidden(){
      playersHidden.value = selected.join(', ');
    }

    // ---------- Add / Remove ----------
    function addName(raw){
      const name = norm(raw);
      if (!name) return;
      if (idxOfName(selected, name) >= 0){
        showToast('Duplicate name', 'info', 1400);
        return;
      }
      selected.push(name);
      renderSelected();
      nameField.value = '';
      nameField.focus();
      haptic('light');
    }

    function removeName(name){
      const i = idxOfName(selected, name);
      if (i >= 0){
        selected.splice(i,1);
        renderSelected(); // re-number pills
      }
    }

    function toggleName(name){
      if (idxOfName(selected, name) >= 0) removeName(name);
      else addName(name);
    }

    // Delegated click for ‚úï remove
    selectedChipList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip-remove');
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      const chip = btn.closest('.draggable');
      if (!chip) return;
      const name = chip.getAttribute('data-name');
      removeName(name);
    });

    // ---------- Desktop HTML5 DnD fallback (only if no Pointer Events) ----------
    function bindSelectedEvents(){
      const hasPointer = 'PointerEvent' in window;
      selectedChipList.querySelectorAll('.draggable').forEach(chip=>{
        if (!hasPointer){
          chip.setAttribute('draggable','true');
          chip.addEventListener('dragstart', (e)=>{ chip.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
          chip.addEventListener('dragend',   ()=> chip.classList.remove('dragging'));
        } else {
          chip.removeAttribute('draggable'); // prevent native DnD when using Pointer Events
        }
      });

      if (!hasPointer) {
        selectedChipList.addEventListener('dragover', (e)=>{
          e.preventDefault();
          const after = getAfter(selectedChipList, e.clientY);
          const dragging = selectedChipList.querySelector('.dragging');
          if (!dragging) return;
          if (!after) selectedChipList.appendChild(dragging);
          else selectedChipList.insertBefore(dragging, after);
        });
        selectedChipList.addEventListener('drop', ()=>{
          commitOrderFromDom(); // re-render to update numbering
        });
      }
    }

    function getAfter(container, y){
      const els = [...container.querySelectorAll('.draggable:not(.dragging)')];
      return els.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        return (offset < 0 && offset > closest.offset) ? {offset, element: child} : closest;
      }, {offset: Number.NEGATIVE_INFINITY, element: null}).element;
    }

    // ---------- Pointer Events drag (modern browsers) ----------
    ;(function(){
      if (!('PointerEvent' in window)) return;
      if (!selectedChipList) return;

      let active = null;        // element being dragged (original)
      let ghost = null;         // floating clone
      let placeholder = null;   // insertion marker
      let startX=0, startY=0;   // pointer down pos
      let offX=0, offY=0;       // offset within chip
      let dragging = false;
      let pointerId=null;

      const TOUCH_SLOP_SQ = 25; // 5px^2 threshold for touch
      function setBodyCursor(grabbing){ document.body.style.cursor = grabbing ? 'grabbing' : ''; }

      function createGhost(fromEl){
        const r = fromEl.getBoundingClientRect();
        const g = fromEl.cloneNode(true);
        g.style.position = 'fixed';
        g.style.left = r.left + 'px';
        g.style.top  = r.top  + 'px';
        g.style.width = r.width + 'px';
        g.style.height = r.height + 'px';
        g.style.pointerEvents = 'none';
        g.style.opacity = '0.85';
        g.style.boxSizing = 'border-box';
        g.classList.add('dragging');
        document.body.appendChild(g);
        return g;
      }
      function makePlaceholder(fromEl){
        const p = document.createElement('div');
        p.className = 'chip placeholder';
        p.style.width  = fromEl.offsetWidth + 'px';
        p.style.height = fromEl.offsetHeight + 'px';
        return p;
      }
      function indexFromPoint(x, y){
        const children = Array.from(selectedChipList.children).filter(el => el !== placeholder);
        if (!children.length) return 0;
        let bestIdx = children.length;
        let bestDist = Infinity;
        children.forEach((el, idx)=>{
          const r = el.getBoundingClientRect();
          const cx = r.left + r.width/2;
          const cy = r.top + r.height/2;
          const dx = cx - x, dy = cy - y;
          const d  = dx*dx + dy*dy;
          if (d < bestDist){ bestDist = d; bestIdx = idx; }
        });
        const near = children[bestIdx];
        if (!near) return children.length;
        const r = near.getBoundingClientRect();
        const before =
          (Math.abs(y - (r.top + r.height/2)) > Math.abs(x - (r.left + r.width/2)))
            ? (y < r.top + r.height/2)
            : (x < r.left + r.width/2);
        return before ? bestIdx : bestIdx + 1;
      }
      function commitOrderFromDom(){
        selected = Array
          .from(selectedChipList.querySelectorAll('.draggable'))
          .map(el=> el.getAttribute('data-name'));
        writeHidden();
        renderSelected(); // re-number after reorder
      }

      function startDrag(){
        if (!active || dragging) return;
        ghost = createGhost(active);
        placeholder = makePlaceholder(active);
        selectedChipList.insertBefore(placeholder, active);
        active.style.visibility = 'hidden'; // keep layout size; avoids jump
        dragging = true;
        setBodyCursor(true);
      }

      function onPointerDown(e){
        e.preventDefault();
        const rmBtn = e.target.closest('.chip-remove');
        if (rmBtn) return;

        const chip = e.target.closest('.draggable');
        if (!chip) return;

        active = chip;
        pointerId = e.pointerId;
        try { active.setPointerCapture(pointerId); } catch(_){ }

        const r = chip.getBoundingClientRect();
        startX = e.clientX; startY = e.clientY;
        offX = startX - r.left; offY = startY - r.top;
        dragging = false;

        if (e.pointerType === 'mouse') {
          startDrag();
        }
      }

      function onPointerMove(e){
        if (!active) return;

        if (!dragging){
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          const dist2 = dx*dx + dy*dy;
          if (e.pointerType !== 'mouse' && dist2 <= TOUCH_SLOP_SQ) return;
          startDrag();
        }

        e.preventDefault();
        const x = e.clientX - offX, y = e.clientY - offY;
        if (ghost){
          ghost.style.left = x + 'px';
          ghost.style.top  = y + 'px';
        }

        const idx = indexFromPoint(e.clientX, e.clientY);
        const target = selectedChipList.children[idx];
        if (!target) selectedChipList.appendChild(placeholder);
        else selectedChipList.insertBefore(placeholder, target);
      }

      function onPointerUp(e){
        if (!active) return;

        if (dragging){
          if (placeholder && placeholder.parentNode){
            selectedChipList.insertBefore(active, placeholder);
          }
          active.style.visibility = '';
          placeholder?.remove(); placeholder = null;
          ghost?.remove(); ghost = null;
          commitOrderFromDom();
        }

        try { active.releasePointerCapture(pointerId); } catch(_){ }
        active = null;
        dragging = false;
        pointerId = null;
        setBodyCursor(false);
      }

      selectedChipList.addEventListener('pointerdown', onPointerDown, { passive:false });
      window.addEventListener('pointermove', onPointerMove, { passive:false });
      window.addEventListener('pointerup', onPointerUp, { passive:false });
      window.addEventListener('pointercancel', onPointerUp, { passive:false });
      window.addEventListener('blur', onPointerUp, { passive:false });
    })();

    // ---------- Form UX ----------
    addNameBtn.addEventListener('click', ()=> addName(nameField.value));
    nameField.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        addName(nameField.value);
      }
    });

    startForm.addEventListener('submit', (e)=>{
      if (!selected.length){
        e.preventDefault();
        showToast('Add at least one player', 'info', 1600);
        nameField.focus();
        return;
      }
      writeHidden();
    });

    // ---------- Helpers ----------
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

    // ---------- Init ----------
    renderRecent();
    renderSelected();
  </script>
  {% endif %}

  {% if (game.phase == 'playing' or game.phase == 'playoff') and not show_stats %}
  <!-- =========================================================
       SCRIPT: PLAYING / PLAYOFF CLIENT RENDER & ACTIONS
       ========================================================= -->
  <script>
    function qs(s){ return document.querySelector(s); }

    // Wake Lock
    let wakeLock;
    async function keepAwake(on){
      try{
        if(on && 'wakeLock' in navigator){
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release',()=>{});
        } else {
          await wakeLock?.release();
          wakeLock = null;
        }
      }catch(e){}
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      const map = { '1':-3, '2':-2, '3':-1, '4':0, '5':+1, '6':+2, 'u':'undo', 'U':'undo' };
      if(!(e.key in map)) return;
      e.preventDefault();
      if (map[e.key]==='undo') { undo(); return; }
      hit(map[e.key], document.body);
    });

    // Local save (resume)
    const SAVE_KEY='darts-golf-game';
    function saveLocal(game){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(game||{})); }catch(_){ } }
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(SAVE_KEY) || 'null'); }catch(_){ return null; } }

    // Track end state for confirm prompts
    let END_ACTIVE = {{ 'true' if game.end_after_round else 'false' }};

    function updateEndButtonLabel(active){
      var b = document.getElementById('endBtn');
      if (b) b.textContent = active ? 'Cancel' : 'End';
    }

    // ---- Anti-flicker sequencing + micro-batching ----
    let __opCounter = 0;
    let __lastCommittedOp = 0;
    let __applyTimer = null;

    function scheduleApplyFromServer(game, opId, force = false) {
      if (force) {
        __lastCommittedOp = Math.max(__lastCommittedOp, opId);
        window.__gameCache = game;
        saveLocal(game);
        renderGame(game);
        return;
      }
      if (opId !== __opCounter) return;
      if (__applyTimer) clearTimeout(__applyTimer);
      __applyTimer = setTimeout(() => {
        if (opId !== __opCounter) return;
        __lastCommittedOp = opId;
        window.__gameCache = game;
        saveLocal(game);
        renderGame(game);
      }, 64);
    }

    async function sendScore(val){
      const snapshot = window.__gameCache ? JSON.parse(JSON.stringify(window.__gameCache)) : null;
      const opId = ++__opCounter;

      try{
        // Optimistic
        if (window.__gameCache){
          const g = JSON.parse(JSON.stringify(window.__gameCache));
          if (g.phase === 'playing'){
            const pIdx = g.current_player_index;
            const player = g.players[pIdx];
            const roundI = g.current_round - 1;

            g.round_history[roundI] = g.round_history[roundI] || {};
            g.scores[player] = (g.scores[player] || 0) + val;
            g.round_history[roundI][player] = val;

            g.undo_history = g.undo_history || [];
            g.undo_history.push({ player_index: pIdx, score_change: val });

            const lastIndex = g.players.length - 1;
            const wasLast   = pIdx === lastIndex;
            if (!(wasLast && g.end_after_round)) {
              g.current_player_index = wasLast ? 0 : pIdx + 1;
              if (wasLast) g.current_round += 1;
            }
          } else if (g.phase === 'playoff'){
            const pIdx = g.current_player_index;
            const player = g.playoff_group[pIdx];
            g.playoff_round_scores = g.playoff_round_scores || {};
            g.playoff_round_scores[player] = val;
            g.current_player_index = Math.min(pIdx + 1, g.playoff_group.length - 1);
          }
          window.__gameCache = g;
          saveLocal(g);
          renderGame(g);
        }

        const res = await fetch('{{ url_for("api_score") }}', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({score:val}) });
        if (!res.ok){ if (__opCounter === opId && snapshot){ window.__gameCache = snapshot; renderGame(snapshot); __lastCommittedOp = opId; } showToast('Couldn‚Äôt save score ‚Äî connection error', 'error'); return; }
        const data = await res.json();
        if (!data.ok){ if (__opCounter === opId && snapshot){ window.__gameCache = snapshot; renderGame(snapshot); __lastCommittedOp = opId; } showToast('Couldn‚Äôt save score ‚Äî server rejected', 'error'); return; }

        if (data.game.phase === 'final_ranking') { location.reload(); return; }

        const force = (data.game.phase !== 'playing' || window.__gameCache.phase !== 'playing');
        scheduleApplyFromServer(data.game, opId, force);
      }catch(e){
        if (__opCounter === opId && snapshot){ window.__gameCache = snapshot; renderGame(snapshot); __lastCommittedOp = opId; }
        showToast('Couldn‚Äôt save score ‚Äî offline?', 'error');
        console.error('Score sync failed', e);
      }
    }

    async function undo(){
      const g0 = window.__gameCache;
      if (!g0 || g0.phase !== 'playing'){ showToast('Undo not available now', 'info', 1400); return; }
      if (!g0.undo_history || !g0.undo_history.length){ showToast('Nothing to undo', 'info', 1400); return; }

      const snapshot = JSON.parse(JSON.stringify(g0));
      const opId = ++__opCounter;

      try{
        const g = JSON.parse(JSON.stringify(g0));
        const n = g.players.length;

        const last_move = g.undo_history.pop();
        const prev_idx = (g.current_player_index - 1 + n) % n;
        g.current_player_index = prev_idx;

        if (prev_idx === n - 1){
          g.current_round = Math.max(1, g.current_round - 1);
        }

        const player_to_undo = g.players[prev_idx];
        const current_round_index = g.current_round - 1;
        g.scores[player_to_undo] = (g.scores[player_to_undo] || 0) - (last_move.score_change || 0);
        g.round_history[current_round_index] = g.round_history[current_round_index] || {};
        delete g.round_history[current_round_index][player_to_undo];

        window.__gameCache = g;
        saveLocal(g);
        renderGame(g);

        const res = await fetch('{{ url_for("api_undo") }}', { method:'POST' });
        if (!res.ok){ if (__opCounter === opId){ window.__gameCache = snapshot; renderGame(snapshot); __lastCommittedOp = opId; } showToast('Undo failed ‚Äî connection error', 'error'); return; }
        const data = await res.json();
        if (!data.ok){ if (__opCounter === opId){ window.__gameCache = snapshot; renderGame(snapshot); __lastCommittedOp = opId; } showToast('Undo failed ‚Äî server rejected', 'error'); return; }

        const force = (data.game.phase !== 'playing' || window.__gameCache.phase !== 'playing');
        scheduleApplyFromServer(data.game, opId, force);
      }catch(e){
        if (__opCounter === opId){ window.__gameCache = snapshot; renderGame(snapshot); __lastCommittedOp = opId; }
        showToast('Undo failed ‚Äî offline?', 'error');
        console.error('Undo sync failed', e);
      }
    }

    async function toggleEnd(){
      if (!END_ACTIVE) {
        const ok = await window.showConfirmModal({ title: 'End', message: 'The game will end after ALL players finish THIS round. Continue?', okText: 'End', cancelText: 'Cancel' });
        if (!ok) return;
      } else {
        const ok = await window.showConfirmModal({ title: 'Cancel End', message: 'The game will continue normally after this round. Continue?', okText: 'Cancel End', cancelText: 'Keep Ending' });
        if (!ok) return;
      }
      var res = await fetch('{{ url_for('api_end_after_round') }}',{method:'POST'});
      var data = await res.json(); if(!data.ok) return;
      window.__gameCache = data.game;
      saveLocal(data.game);
      renderGame(data.game);
    }

    function renderGame(g){
      keepAwake(g.phase==='playing' || g.phase==='playoff');

      if(g.phase==='playing'){ renderPlaying(g); var u=qs('#undoBtn'); if(u) u.removeAttribute('disabled'); }
      else if(g.phase==='playoff'){ renderPlayoff(g); var u2=qs('#undoBtn'); if(u2) u2.setAttribute('disabled','disabled'); }

      END_ACTIVE = !!g.end_after_round;
      updateEndButtonLabel(END_ACTIVE);
    }

    function sign(v){ return v>0?'+':''; }

    function renderPlaying(g){
      var banner = g.end_after_round
        ? '<div class="end-banner-wrap"><div class="end-banner">Game will end after this round. Finish all players this round to finalize and run tie-breakers.</div></div>'
        : '';
      qs('#info-bar').innerHTML =
        '<div class="round-count">'+
           '<span class="round-label">ROUND</span>'+
           '<span class="round-number">'+String(g.current_round).padStart(2,'0')+'</span>'+
           '<span class="round-total">/ 20</span>'+
         '</div>'+
         '<div class="turn-info">'+g.players[g.current_player_index]+"'s Turn</div>"+banner;

      var headers = g.players.map(function(p,i){return '<th class="'+(i===g.current_player_index?'current-player-header':'')+'">'+p+'</th>';}).join('');
      var thead = '<thead><tr><th>&nbsp;</th>'+headers+'</tr></thead>';

      var totals = g.players.map(function(p){
        var s = g.scores[p] || 0;
        return '<td>'+sign(s)+s+'</td>';
      }).join('');

      var tbody = '<tbody><tr class="total-row"><th>Total</th>'+totals+'</tr>';

      var curIdx = g.current_round - 1;
      var curRow = g.round_history[curIdx] || {};
      var currentCells = g.players.map(function(p){
        var v = curRow[p];
        if (typeof v === 'undefined') {
          return '<td><div class="cell"><span class="total-pill">0</span><span class="delta-corner hidden">0</span></div></td>';
        }
        var running = g.round_history.slice(0, g.current_round).reduce(function(sum, rh){ return sum + (rh[p]||0); }, 0);
        return '<td><div class="cell"><span class="total-pill">'+(running>0?'+':'')+running+'</span><span class="delta-corner '+(v>0?'pos':(v<0?'neg':'zero'))+'">'+(v>0?'+':'')+v+'</span></div></td>';
      }).join('');
      tbody += '<tr class="current-row"><th>'+String(g.current_round).padStart(2,'0')+'</th>'+currentCells+'</tr>';

      for(var i=g.current_round-2;i>=0;i--){
        var row = g.round_history[i] || {};
        var cells = g.players.map(function(p){
          var v = row[p];
          if (typeof v === 'undefined') return '<td></td>';
          var running = g.round_history.slice(0, i+1).reduce(function(sum, rh){ return sum + (rh[p]||0); }, 0);
          return '<td><div class="cell"><span class="total-pill">'+(running>0?'+':'')+running+'</span><span class="delta-corner '+(v>0?'pos':(v<0?'neg':'zero'))+'">'+(v>0?'+':'')+v+'</span></div></td>';
        }).join('');
        tbody += '<tr><th>'+String(i+1).padStart(2,'0')+'</th>'+cells+'</tr>';
      }

      tbody += '</tbody>';
      qs('#scoreboard').innerHTML = thead+tbody;
    }

    function renderPlayoff(g){
      qs('#info-bar').innerHTML =
        '<div class="round-count"><span class="round-label">TIE-BREAKER</span><span class="round-number">'+String(g.playoff_round).padStart(2,'0')+'</span></div>'+
        '<div class="turn-info">'+g.playoff_group[g.current_player_index] + "'s Turn</div>";
      var headers = g.playoff_group.map(function(p,i){return '<th class="'+(i===g.current_player_index?'current-player-header':'')+'">'+p+'</th>';}).join('');
      var thead = '<thead><tr><th>&nbsp;</th>'+headers+'</tr></thead>';

      var totals = g.playoff_group.map(function(){ var s = g.playoff_base_score || 0; return '<td>'+(s>0?'+':'')+s+'</td>'; }).join('');

      var tbody = '<tbody><tr class="total-row"><th>Total</th>'+totals+'</tr>';

      for (var idx = g.playoff_history.length - 1; idx >= 0; idx--) {
        var round_scores = g.playoff_history[idx] || {};
        var tbNum = idx + 1;
        var cells = g.playoff_group.map(function(p){
          var v = round_scores[p];
          if (typeof v === 'undefined') return '<td></td>';
          return '<td>'+(v>0?'+':'')+v+'</td>';
        }).join('');
        tbody += '<tr><th>TB '+String(tbNum).padStart(2,'0')+'</th>'+cells+'</tr>';
      }

      tbody += '</tbody>';
      qs('#scoreboard').innerHTML = thead+tbody;
    }

    var LABELS = { "-3":"Albatross","-2":"Eagle","-1":"Birdie","0":"Par","1":"Bogey","2":"Double Bogey" };
    function hit(val, el){
      haptic('light');
      showBubbleFor(val, el);
      sendScore(val);
    }
    function showBubbleFor(val, el){
      var key = String(val), label = (typeof LABELS[key] !== 'undefined') ? LABELS[key] : (val>0?('+'+val):String(val));
      var cls = val > 0 ? 'pos' : (val < 0 ? 'neg' : 'zero');
      var rect = el.getBoundingClientRect(), x = rect.left + (rect.width/2), y = rect.top - 6;
      var bubble = document.createElement('div'); bubble.className = 'score-bubble '+cls; bubble.textContent = label;
      bubble.style.left = x + 'px'; bubble.style.top  = y + 'px'; document.body.appendChild(bubble);
      var remove = function(){ if (bubble && bubble.parentNode) bubble.parentNode.removeChild(bubble); };
      bubble.addEventListener('animationend', remove, { once:true }); setTimeout(remove, 1500);
    }

    keepAwake(true);
    updateEndButtonLabel(END_ACTIVE);

    (function(){
      const saved = loadLocal();
      const g = window.__gameCache;
      if (!saved || !saved.phase || saved.phase==='setup') return;
      if (g && g.phase !== 'setup') return;
      showActionToast('Resume previous game?', 'Resume', async ()=>{ location.reload(); }, 'info', 10000);
    })();
  </script>
  {% endif %}

  {% if game.phase == 'final_ranking' and not show_stats %}
  <!-- =========================================================
       SCRIPT: CONFETTI ON WINNER
       ========================================================= -->
  <script>
    (function(){
      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (prefersReduced) return;

      const canvas = document.getElementById('confettiCanvas');
      const ctx = canvas.getContext('2d');
      let W, H, raf, t0;
      const pieces = [];
      function resize(){ W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
      window.addEventListener('resize', resize); resize();

      function spawn(n){
        for(let i=0;i<n;i++){
          pieces.push({
            x: Math.random()*W, y: -20 - Math.random()*H*0.3,
            vx: (Math.random()-0.5)*2, vy: 2+Math.random()*3,
            size: 5+Math.random()*8, rot: Math.random()*Math.PI, vr: (Math.random()-0.5)*0.2,
            shape: Math.random()<0.5?'rect':'tri'
          });
        }
      }
      function step(ts){
        if(!t0) t0 = ts;
        const dt = Math.min(32, ts - t0); t0 = ts;
        ctx.clearRect(0,0,W,H);
        for (const p of pieces){
          p.vy += 0.01; p.x += p.vx; p.y += p.vy; p.rot += p.vr;
          if (p.y > H+40) { p.y = -20; p.x = Math.random()*W; p.vy = 2+Math.random()*3; }
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = ['#E3292E','#309F6A','#F9DFBC','#ffffff','#ffd54f'][Math.floor(Math.random()*5)];
          if (p.shape==='rect'){ ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6); }
          else {
            ctx.beginPath();
            ctx.moveTo(0,-p.size/2); ctx.lineTo(p.size/2,p.size/2); ctx.lineTo(-p.size/2,p.size/2); ctx.closePath(); ctx.fill();
          }
          ctx.restore();
        }
        raf = requestAnimationFrame(step);
      }
      spawn(180);
      raf = requestAnimationFrame(step);
      setTimeout(()=>{ cancelAnimationFrame(raf); ctx.clearRect(0,0,W,H); }, 6000);
    })();
  </script>
  {% endif %}

  <!-- =========================================================
       SCRIPT: SETTINGS MODAL LOGIC
       ========================================================= -->
  <script>
    const settingsOverlay = document.getElementById('settingsOverlay');
    const hapticsToggle   = document.getElementById('hapticsToggle');
    const settingsSummary = document.getElementById('settingsSummary');

    function openSettings(){
      hapticsToggle.checked = window.hapticsPref.isOn();
      const onOff = hapticsToggle.checked ? 'on' : 'off';
      settingsSummary.textContent = `haptics ${onOff}`;
      if (typeof window.updateInstallVisibility === 'function') {
        window.updateInstallVisibility();
      }
      settingsOverlay.style.display = 'flex';
      settingsOverlay.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeSettings(){
      settingsOverlay.style.display = 'none';
      settingsOverlay.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }
    function saveSettings(){
      window.hapticsPref.set(!!hapticsToggle.checked);
      const onOff = hapticsToggle.checked ? 'on' : 'off';
      settingsSummary.textContent = `haptics ${onOff}`;
      showToast('Settings saved', 'success');
      closeSettings();
    }
  </script>

  <!-- =========================================================
       SCRIPT: GLOBAL SCROLL GUARD FOR iOS
       (blocks page rubber-band; only .container scrolls)
       ========================================================= -->
  <script>
    (function(){
      const scrollArea = document.querySelector('.container'); // only scrollable region
      let startY = 0;
      let insideScrollable = false;

      function isInsideScrollable(el) {
        let n = el;
        while (n && n !== document.body) {
          if (n === scrollArea) return true;
          n = n.parentElement;
        }
        return false;
      }

      document.addEventListener('touchstart', (e) => {
        insideScrollable = isInsideScrollable(e.target);
        startY = (e.touches && e.touches.length) ? e.touches[0].clientY : 0;
      }, { passive: true });

      document.addEventListener('touchmove', (e) => {
        if (!scrollArea) { e.preventDefault(); return; }

        // If touch is outside the scroll area, block it outright.
        if (!insideScrollable) { e.preventDefault(); return; }

        // Inside scroll area: block rubber-band when at edges and trying to go past
        const y = (e.touches && e.touches.length) ? e.touches[0].clientY : startY;
        const dy = y - startY;

        const atTop = scrollArea.scrollTop <= 0;
        const atBottom = scrollArea.scrollTop + scrollArea.clientHeight >= scrollArea.scrollHeight - 1;

        if ((atTop && dy > 0) || (atBottom && dy < 0)) {
          e.preventDefault(); // stop bounce from reaching <body>
        }
      }, { passive: false });

      // Block wheel/trackpad page scroll (iPadOS / desktop Safari)
      document.addEventListener('wheel', (e) => {
        if (!isInsideScrollable(e.target)) e.preventDefault();
      }, { passive: false });

      // Also hard-lock explicitly marked regions (e.g., bottom controls)
      document.querySelectorAll('[data-lock-scroll]').forEach(el=>{
        el.addEventListener('touchmove', e => e.preventDefault(), { passive:false });
        el.addEventListener('wheel',     e => e.preventDefault(), { passive:false });
      });
    })();
  </script>

  <!-- =========================================================
       SCRIPT: RAISE CONTROLS FOR IPHONE + SET CONTAINER BOTTOM INSET
       (fixed controls; only compute height; no extra spacer)
       ========================================================= -->
<script>
  (function(){
    const root = document.documentElement;
    const controls = document.querySelector('.controls');
    function setH(){ if (controls) root.style.setProperty('--controls-h', controls.getBoundingClientRect().height + 'px'); }
    window.addEventListener('load', setH, {once:true});
    window.addEventListener('resize', setH);
    window.addEventListener('orientationchange', setH);
    // iOS visual viewport changes
    if (window.visualViewport){
      visualViewport.addEventListener('resize', setH);
      visualViewport.addEventListener('scroll', setH);
    }
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setH(); });
  })();
</script>

  <!-- =========================================================
       CONTROLS (BOTTOM BAR)
       ========================================================= -->
  {% if show_stats %}
    <div class="controls no-overscroll" data-lock-scroll>
      <div class="button-grid two" data-lock-scroll>
        <a href="{{ url_for('index') }}"><button type="button" class="export-btn">Back</button></a>
        <form id="restartForm" action="{{ url_for('restart') }}" method="post">
          <button type="button" id="restartBtn" class="restart-btn">New Game</button>
        </form>
      </div>
    </div>
  {% elif game.phase == 'setup' %}
    <!-- Bottom controls for SETUP ‚Äî unified button-grid two -->
    <div class="controls no-overscroll" data-lock-scroll>
      <div class="button-grid two" data-lock-scroll>
        <button type="button" class="settings-btn" onclick="openSettings()">Settings</button>
        <!-- Submit the existing #startForm from here -->
        <button type="submit" class="export-btn" form="startForm">Start Game</button>
      </div>
    </div>
  {% elif game.phase in ['playing','playoff'] %}
    <div class="controls no-overscroll" data-lock-scroll>
      <div class="button-grid" data-lock-scroll>
        <button type="button" class="score-btn minus" onclick="hit(-3, this)">-3</button>
        <button type="button" class="score-btn minus" onclick="hit(-2, this)">-2</button>
        <button type="button" class="score-btn minus" onclick="hit(-1, this)">-1</button>
        <button type="button" class="score-btn zero"  onclick="hit(0,  this)">0</button>
        <button type="button" class="score-btn plus"  onclick="hit(1,  this)">+1</button>
        <button type="button" class="score-btn plus"  onclick="hit(2,  this)">+2</button>
      </div>
      <div class="button-grid two playing" data-lock-scroll>
        <button type="button" id="undoBtn" class="undo-btn" onclick="undo()" {{ 'disabled' if game.phase == 'playoff' else '' }}>Undo</button>
        <button type="button" id="endBtn" class="end-btn" onclick="toggleEnd()">{{ 'Cancel' if game.end_after_round else 'End' }}</button>
      </div>
    </div>
  {% elif game.phase == 'final_ranking' %}
    <div class="controls no-overscroll" data-lock-scroll>
      <div class="button-grid two" data-lock-scroll>
        <a href="{{ url_for('stats') }}"><button type="button" class="export-btn">Stats</button></a>
        <form id="restartForm" action="{{ url_for('restart') }}" method="post">
          <button type="button" id="restartBtn" class="restart-btn">New Game</button>
        </form>
      </div>
    </div>
  {% endif %}

  <!-- Attach confirm to Start New Game -->
  <script>
    (function(){
      var btn = document.getElementById('restartBtn');
      var form = document.getElementById('restartForm');
      if (btn && form) {
        btn.addEventListener('click', async function(){
          const ok = await window.showConfirmModal({
            title: 'Start New Game',
            message: 'This will clear the current game and return to setup. Continue?',
            okText: 'Start New Game',
            cancelText: 'Cancel'
          });
          if (ok) form.submit();
        });
      }
    })();
  </script>
</body>
</html>
